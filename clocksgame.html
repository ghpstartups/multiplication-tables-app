<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Time Mastery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Prevent scrolling and bouncing on mobile */
    body { 
        font-family: 'Inter', sans-serif; 
        position: fixed; 
        width: 100%; 
        height: 100dvh; /* Dynamic viewport height */
        overflow: hidden; 
        background-color: #e0e7ff; 
        touch-action: manipulation;
    }
    .fredoka { font-family: 'Fredoka One', cursive; font-variant-numeric: tabular-nums; }
    
    /* 3D Card Flip */
    .card-container { perspective: 1000px; }
    .card { transform-style: preserve-3d; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; width: 100%; height: 100%; }
    .card.is-flipped { transform: rotateY(180deg); }
    .card-face { backface-visibility: hidden; -webkit-backface-visibility: hidden; position: absolute; inset: 0; }
    .card-face-back { transform: rotateY(180deg); }

    /* Button Animations */
    .btn-press { transition: transform 0.05s, background-color 0.1s; }
    .btn-press:active { transform: scale(0.95); }

    /* Progress Dots */
    .problem-dot { width: 12px; height: 12px; border-radius: 50%; margin: 2px; transition: all 0.3s ease; }
    .dot-pending { background-color: #cbd5e1; }
    .dot-correct { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
    .dot-wrong { background-color: #ef4444; }
    .dot-current { border: 2px solid #4f46e5; background-color: white; transform: scale(1.3); }

    /* Inputs */
    .time-input {
        height: 50px; width: 65px; font-size: 2rem; border: 3px solid #cbd5e1; border-radius: 12px;
        display: flex; align-items: center; justify-content: center; background: #fff; color: #333;
        font-family: 'Fredoka One', cursive;
    }
    .time-input.active-input { border-color: #4f46e5; background: #eef2ff; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }

    /* Keypad */
    #keypad { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; height: 100%; }
    .keypad-btn { font-size: 1.5rem; border-radius: 12px; border-bottom-width: 4px; height: 100%; }
    
    /* Modals */
    .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    
    /* Timer */
    .timer-bar { height: 6px; background-color: #ef4444; width: 100%; transition: width 0.1s linear; }

    /* Canvas Responsiveness */
    canvas { max-width: 100%; max-height: 100%; }
  </style>
</head>
<body class="flex flex-col items-center justify-center">

  <div id="setup-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm text-center border-4 border-indigo-100">
      <h1 class="text-3xl fredoka text-indigo-600 mb-1">Time Mastery</h1>
      <p class="text-gray-400 text-sm mb-6">Learn to read and calculate time!</p>
      
      <div id="setup-content">
          <div class="flex flex-col gap-3">
              <button onclick="selectMode('read')" class="btn-press bg-indigo-50 border-2 border-indigo-200 p-4 rounded-xl text-left flex items-center gap-3 hover:bg-indigo-100">
                  <div class="text-3xl">üïí</div>
                  <div>
                      <h3 class="font-bold text-indigo-900">Read Clock</h3>
                      <p class="text-xs text-gray-500">What time is it?</p>
                  </div>
              </button>
              <button onclick="selectMode('easy')" class="btn-press bg-indigo-50 border-2 border-indigo-200 p-4 rounded-xl text-left flex items-center gap-3 hover:bg-indigo-100">
                  <div class="text-3xl">‚ûï</div>
                  <div>
                      <h3 class="font-bold text-indigo-900">Easy Math</h3>
                      <p class="text-xs text-gray-500">Difference (Same Hour)</p>
                  </div>
              </button>
              <button onclick="selectMode('hard')" class="btn-press bg-indigo-50 border-2 border-indigo-200 p-4 rounded-xl text-left flex items-center gap-3 hover:bg-indigo-100">
                  <div class="text-3xl">üß†</div>
                  <div>
                      <h3 class="font-bold text-indigo-900">Hard Math</h3>
                      <p class="text-xs text-gray-500">Difference (Change Hour)</p>
                  </div>
              </button>
          </div>
      </div>
    </div>
  </div>

  <div id="game-ui" class="hidden w-full h-full max-w-md flex flex-col relative bg-white md:rounded-3xl md:h-[95dvh] md:border-4 md:border-indigo-100 md:shadow-2xl overflow-hidden">
    
    <div class="flex-none bg-indigo-50 p-2 border-b border-indigo-100">
        <div class="flex justify-between items-center mb-1 px-2">
            <button onclick="togglePause()" id="pause-btn" class="btn-press bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm">Pause</button>
            <div class="text-2xl fredoka text-indigo-600 tracking-widest" id="game-clock">00:00</div>
            <button onclick="location.reload()" class="btn-press bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm">Quit</button>
        </div>
        <div id="progress-dots" class="flex justify-center flex-wrap gap-1 px-4 h-4"></div>
    </div>

    <div class="w-full bg-gray-200 h-1.5"><div id="timer-bar" class="timer-bar"></div></div>

    <div class="flex-grow relative p-2 overflow-hidden bg-white">
        <div class="card-container w-full h-full">
            <div id="game-card" class="card">
                
                <div class="card-face bg-white flex flex-col">
                    
                    <div id="visual-container" class="flex-grow flex flex-col items-center justify-center p-1 relative">
                        </div>

                    <div class="flex-none pt-2 pb-1">
                        <div id="inputs-wrapper" class="flex justify-center items-center gap-2 mb-2 h-14">
                            </div>
                        
                        <div id="keypad" class="h-44 w-full"></div>
                    </div>
                </div>

                <div class="card-face card-face-back bg-indigo-600 text-white flex flex-col items-center justify-center rounded-2xl">
                    <div id="feedback-icon" class="text-7xl mb-2">‚ùå</div>
                    <div class="text-2xl font-bold mb-4">Correct Answer:</div>
                    <div id="correct-answer-display" class="text-4xl fredoka bg-white/20 px-6 py-3 rounded-xl backdrop-blur-sm">
                        --:--
                    </div>
                </div>

            </div>
        </div>
    </div>
  </div>

  <div id="end-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center relative overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div id="end-icon" class="text-8xl mb-2">üèÜ</div>
        <h2 id="end-title" class="text-4xl fredoka text-indigo-600 mb-2">Finished!</h2>
        <p id="end-message" class="text-gray-500 mb-6">Great job!</p>
        <button id="end-action-btn" class="btn-press w-full bg-indigo-600 text-white py-4 rounded-xl text-xl font-bold shadow-lg shadow-indigo-200">
            Play Again
        </button>
    </div>
  </div>

  <script>
    // --- STATE & CONFIG ---
    const CONFIG = {
        questionsTotal: 10,
        timerSeconds: 15,
    };

    const STATE = {
        mode: null, 
        problems: [], 
        currentIdx: 0,
        wrongList: [],
        inputs: [],
        focusedInput: 0,
        
        isPaused: false,
        timerVal: 0,
        startTime: 0,
        elapsed: 0,
        clockInt: null,
        animFrame: null,
        
        isPractice: false
    };

    // --- AUDIO SYSTEM (Tone.js) ---
    const audio = {
        synth: new Tone.Synth().toDestination(),
        badSynth: new Tone.Synth({ oscillator: { type: "sawtooth" } }).toDestination(),
        poly: new Tone.PolySynth().toDestination()
    };
    
    let audioStarted = false;

    async function initAudio() {
        if(!audioStarted) {
            await Tone.start();
            audioStarted = true;
            // Set volumes
            audio.synth.volume.value = -5;
            audio.badSynth.volume.value = -5;
            audio.poly.volume.value = -8;
        }
    }

    function playSound(type) {
        if(!audioStarted) return;
        const now = Tone.now();
        switch(type) {
            case 'click': audio.synth.triggerAttackRelease("C5", "32n", now); break;
            case 'correct': 
                audio.poly.triggerAttackRelease(["C5", "E5", "G5"], "16n", now); 
                audio.poly.triggerAttackRelease(["E5", "G5", "C6"], "8n", now + 0.1);
                break;
            case 'wrong': 
                audio.badSynth.triggerAttackRelease("A2", "8n", now); 
                audio.badSynth.triggerAttackRelease("F2", "8n", now + 0.15);
                break;
            case 'win':
                audio.poly.triggerAttackRelease(["C4","E4","G4"], "8n", now);
                audio.poly.triggerAttackRelease(["D4","F4","A4"], "8n", now+0.1);
                audio.poly.triggerAttackRelease(["E4","G4","B4"], "8n", now+0.2);
                audio.poly.triggerAttackRelease(["F4","A4","C5"], "2n", now+0.3);
                break;
        }
    }

    // --- GENERATORS ---
    function generateProblems(mode, count) {
        let arr = [];
        for(let i=0; i<count; i++) {
            let p = { mode: mode };
            if(mode === 'read') {
                p.h1 = rInt(1, 12);
                p.m1 = rInt(0, 59);
                p.answer = [p.h1, p.m1];
            } else if (mode === 'easy') {
                p.h1 = rInt(1, 12);
                p.m1 = rInt(0, 45); 
                p.diff = rInt(5, 59 - p.m1); // Ensure stays in hour
                p.h2 = p.h1;
                p.m2 = p.m1 + p.diff;
                p.answer = [p.diff];
            } else { // hard
                p.h1 = rInt(1, 12);
                p.m1 = rInt(30, 55); 
                const diff = rInt(60 - p.m1 + 5, 50); // Cross hour
                let total = p.m1 + diff;
                p.h2 = p.h1 + 1; 
                if(p.h2 > 12) p.h2 = 1;
                p.m2 = total - 60;
                p.answer = [diff];
            }
            arr.push(p);
        }
        return arr;
    }
    function rInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // --- GAME CONTROL ---
    async function selectMode(mode) {
        await initAudio();
        STATE.mode = mode;
        STATE.isPractice = false;
        STATE.problems = generateProblems(mode, CONFIG.questionsTotal);
        startGame();
    }

    function startGame() {
        STATE.currentIdx = 0;
        STATE.wrongList = [];
        STATE.startTime = Date.now();
        STATE.elapsed = 0;
        
        document.getElementById('setup-modal').classList.add('hidden');
        document.getElementById('end-modal').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        
        renderDots();
        initKeypad();
        loadLevel();
        startClock();
    }

    function loadLevel() {
        const p = STATE.problems[STATE.currentIdx];
        const container = document.getElementById('visual-container');
        container.innerHTML = ''; // clear

        // 1. Draw Visuals
        if (STATE.mode === 'read') {
            const cvs = createClockCanvas(110, p.h1, p.m1); // Max size
            container.appendChild(cvs);
        } else {
            // Math modes: Vertical Layout
            const wrap = document.createElement('div');
            wrap.className = "flex flex-col items-center justify-center gap-1 h-full";
            
            // Top Clock
            wrap.appendChild(createClockCanvas(70, p.h1, p.m1));
            
            // Arrow
            const arrow = document.createElement('div');
            arrow.innerHTML = '‚¨áÔ∏è'; 
            arrow.className = "text-2xl animate-bounce leading-none";
            wrap.appendChild(arrow);
            
            // Bottom Clock
            wrap.appendChild(createClockCanvas(70, p.h2, p.m2));
            
            container.appendChild(wrap);
        }

        // 2. Setup Inputs
        setupInputs(p);
        
        // 3. Reset Timer
        resetTimer();
        
        // 4. Update Dot
        document.querySelectorAll('.problem-dot').forEach((d,i) => {
            if(i === STATE.currentIdx) d.classList.add('dot-current');
            else d.classList.remove('dot-current');
        });
    }

    function setupInputs(p) {
        const wrap = document.getElementById('inputs-wrapper');
        wrap.innerHTML = '';
        STATE.inputs = [];
        STATE.focusedInput = 0;

        if (STATE.mode === 'read') {
            // Hour
            const iH = createInputEl();
            wrap.appendChild(iH);
            STATE.inputs.push(iH);
            
            const sep = document.createElement('div');
            sep.innerHTML = ':'; sep.className = 'text-4xl text-gray-400 font-bold pb-2';
            wrap.appendChild(sep);
            
            // Min
            const iM = createInputEl();
            wrap.appendChild(iM);
            STATE.inputs.push(iM);
        } else {
            // Diff
            const i = createInputEl();
            i.style.width = '100px';
            wrap.appendChild(i);
            STATE.inputs.push(i);
            
            const lbl = document.createElement('div');
            lbl.innerText = 'mins'; lbl.className = 'text-indigo-400 font-bold ml-1';
            wrap.appendChild(lbl);
        }
        highlightInput();
    }

    function createInputEl() {
        const d = document.createElement('div');
        d.className = 'time-input';
        d.onclick = (e) => {
            const idx = STATE.inputs.indexOf(e.target);
            if(idx > -1) { STATE.focusedInput = idx; highlightInput(); }
        };
        return d;
    }

    function highlightInput() {
        STATE.inputs.forEach((el, i) => {
            if(i === STATE.focusedInput) el.classList.add('active-input');
            else el.classList.remove('active-input');
        });
    }

    // --- CANVAS DRAWING ---
    function createClockCanvas(radius, h, m) {
        const canvas = document.createElement('canvas');
        const size = radius * 2 + 10;
        // High DPI scaling
        canvas.width = size * 2; 
        canvas.height = size * 2;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        
        const ctx = canvas.getContext('2d');
        ctx.scale(2, 2); // Scale for retina
        
        const cx = size/2;
        const cy = size/2;

        // Face
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI*2);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#3730a3'; // Indigo-800
        ctx.stroke();

        // Ticks (Minutes)
        for(let i=0; i<60; i++) {
            const ang = (i*6) * Math.PI/180;
            const isHour = i%5 === 0;
            const len = isHour ? 10 : 5;
            const width = isHour ? 3 : 1;
            
            ctx.beginPath();
            ctx.moveTo(cx + Math.sin(ang)*(radius-len), cy - Math.cos(ang)*(radius-len));
            ctx.lineTo(cx + Math.sin(ang)*(radius-2), cy - Math.cos(ang)*(radius-2));
            ctx.strokeStyle = '#333';
            ctx.lineWidth = width;
            ctx.stroke();
        }

        // Numbers
        ctx.fillStyle = '#1e1b4b';
        ctx.font = `bold ${radius*0.22}px 'Fredoka One'`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for(let i=1; i<=12; i++) {
            const ang = (i*30) * Math.PI/180;
            const rNum = radius * 0.75;
            ctx.fillText(i, cx + Math.sin(ang)*rNum, cy - Math.cos(ang)*rNum);
        }

        // Hands
        // Minute
        const mAng = (m*6) * Math.PI/180;
        drawHand(ctx, cx, cy, mAng, radius*0.85, 4, '#374151');
        // Hour
        const hAng = ((h%12)*30 + m*0.5) * Math.PI/180;
        drawHand(ctx, cx, cy, hAng, radius*0.55, 6, '#4f46e5');

        // Pin
        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, Math.PI*2);
        ctx.fillStyle = '#ef4444';
        ctx.fill();

        return canvas;
    }

    function drawHand(ctx, cx, cy, ang, len, width, color) {
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.sin(ang)*len, cy - Math.cos(ang)*len);
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = 'round';
        ctx.stroke();
    }

    // --- KEYPAD ---
    function initKeypad() {
        const k = document.getElementById('keypad');
        k.innerHTML = '';
        const keys = ['1','2','3','4','5','6','7','8','9','‚å´','0','‚úì'];
        keys.forEach(key => {
            const b = document.createElement('button');
            b.className = "keypad-btn bg-white text-indigo-600 font-bold border-indigo-200 border shadow-sm active:bg-indigo-50";
            b.innerText = key;
            if(key === '‚úì') {
                b.className = "keypad-btn bg-green-500 text-white border-green-600 active:bg-green-600";
                b.onclick = submitAnswer;
            } else if (key === '‚å´') {
                b.className = "keypad-btn bg-gray-200 text-gray-500 border-gray-300 active:bg-gray-300";
                b.onclick = backspace;
            } else {
                b.onclick = () => typeNum(key);
            }
            k.appendChild(b);
        });
    }

    function typeNum(n) {
        playSound('click');
        const inp = STATE.inputs[STATE.focusedInput];
        if(inp.innerText.length < 2) {
            inp.innerText += n;
            // Auto advance
            if(inp.innerText.length === 2 && STATE.mode === 'read' && STATE.focusedInput === 0) {
                STATE.focusedInput = 1; highlightInput();
            }
        }
    }

    function backspace() {
        playSound('click');
        const inp = STATE.inputs[STATE.focusedInput];
        inp.innerText = inp.innerText.slice(0, -1);
    }

    // --- GAME LOOP LOGIC ---
    function submitAnswer() {
        // Collect answer
        const vals = STATE.inputs.map(el => parseInt(el.innerText));
        if(vals.some(isNaN)) return; // Empty inputs

        const p = STATE.problems[STATE.currentIdx];
        let correct = true;
        
        // Check logic
        if(STATE.mode === 'read') {
            if(vals[0] !== p.answer[0] || vals[1] !== p.answer[1]) correct = false;
        } else {
            if(vals[0] !== p.answer[0]) correct = false;
        }

        // Result UI
        const dot = document.getElementById(`dot-${STATE.currentIdx}`);
        if(correct) {
            playSound('correct');
            dot.classList.remove('dot-pending', 'dot-current');
            dot.classList.add('dot-correct');
            setTimeout(nextLevel, 800);
        } else {
            playSound('wrong');
            dot.classList.remove('dot-pending', 'dot-current');
            dot.classList.add('dot-wrong');
            STATE.wrongList.push(p); // Add to practice
            
            // Show Card Flip
            const display = document.getElementById('correct-answer-display');
            if(STATE.mode === 'read') display.innerText = `${p.h1}:${String(p.m1).padStart(2,'0')}`;
            else display.innerText = `${p.answer[0]} mins`;

            document.getElementById('game-card').classList.add('is-flipped');
            setTimeout(() => {
                document.getElementById('game-card').classList.remove('is-flipped');
                setTimeout(nextLevel, 300);
            }, 2500);
        }
    }

    function nextLevel() {
        STATE.currentIdx++;
        if(STATE.currentIdx >= STATE.problems.length) {
            endGame();
        } else {
            loadLevel();
        }
    }

    function endGame() {
        stopTimer();
        clearInterval(STATE.clockInt);
        
        const modal = document.getElementById('end-modal');
        const title = document.getElementById('end-title');
        const msg = document.getElementById('end-message');
        const btn = document.getElementById('end-action-btn');
        const icon = document.getElementById('end-icon');

        modal.classList.remove('hidden');

        if(STATE.wrongList.length === 0) {
            // Perfect
            playSound('win');
            icon.innerText = "üèÜ";
            title.innerText = "Perfect!";
            msg.innerText = "You got them all right!";
            btn.innerText = "Play Again";
            btn.onclick = () => { selectMode(STATE.mode); }; // Restart same mode
        } else {
            // Needs Practice
            playSound('wrong'); // sound effect prompt
            icon.innerText = "üí™";
            title.innerText = "Keep Going!";
            msg.innerText = `You missed ${STATE.wrongList.length} questions. Let's fix them!`;
            btn.innerText = "Practice Mistakes";
            btn.onclick = startPractice;
        }
    }

    function startPractice() {
        STATE.isPractice = true;
        STATE.problems = [...STATE.wrongList];
        STATE.wrongList = []; // clear for new round
        startGame(); // re-runs with new problem set
    }

    // --- TIMERS ---
    function startClock() {
        if(STATE.clockInt) clearInterval(STATE.clockInt);
        STATE.clockInt = setInterval(() => {
            if(!STATE.isPaused) {
                STATE.elapsed += 1000;
                const m = Math.floor(STATE.elapsed / 60000);
                const s = Math.floor((STATE.elapsed % 60000) / 1000);
                document.getElementById('game-clock').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
        }, 1000);
    }

    function resetTimer() {
        STATE.timerVal = CONFIG.timerSeconds;
        animateTimer();
    }
    
    function animateTimer() {
        if(STATE.animFrame) cancelAnimationFrame(STATE.animFrame);
        let lastTime = performance.now();
        
        function loop(now) {
            if(!STATE.isPaused && !document.getElementById('game-card').classList.contains('is-flipped')) {
                const delta = (now - lastTime) / 1000;
                STATE.timerVal -= delta;
                
                const pct = (STATE.timerVal / CONFIG.timerSeconds) * 100;
                const bar = document.getElementById('timer-bar');
                bar.style.width = pct + '%';
                
                if(STATE.timerVal <= 0) {
                    // Time Up -> Force Wrong
                    // Fill inputs with ?? to trigger wrong state check
                    STATE.inputs.forEach(i => i.innerText = "0");
                    submitAnswer();
                    return; 
                }
            }
            lastTime = now;
            STATE.animFrame = requestAnimationFrame(loop);
        }
        STATE.animFrame = requestAnimationFrame(loop);
    }
    
    function stopTimer() {
        if(STATE.animFrame) cancelAnimationFrame(STATE.animFrame);
    }

    function togglePause() {
        STATE.isPaused = !STATE.isPaused;
        const btn = document.getElementById('pause-btn');
        const cover = document.getElementById('game-card');
        if(STATE.isPaused) {
            btn.innerText = "RESUME";
            btn.classList.add('bg-green-500', 'text-white');
            btn.classList.remove('bg-yellow-400', 'text-yellow-900');
            cover.classList.add('opacity-10');
        } else {
            btn.innerText = "PAUSE";
            btn.classList.remove('bg-green-500', 'text-white');
            btn.classList.add('bg-yellow-400', 'text-yellow-900');
            cover.classList.remove('opacity-10');
        }
    }

    // --- RENDER HELPERS ---
    function renderDots() {
        const c = document.getElementById('progress-dots');
        c.innerHTML = '';
        for(let i=0; i<STATE.problems.length; i++) {
            const d = document.createElement('div');
            d.className = 'problem-dot dot-pending';
            d.id = `dot-${i}`;
            c.appendChild(d);
        }
    }
  </script>
</body>
</html>
