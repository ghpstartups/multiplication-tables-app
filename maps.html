<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US States Flip Map</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,0.06);
      --stroke:rgba(255,255,255,0.35);

      --front:rgba(255,255,255,0.10);
      --frontHover:rgba(255,255,255,0.18);
      --back:rgba(255,255,255,0.16);

      --selectedFront: rgba(120, 230, 170, 0.24);
      --selectedBack:  rgba(120, 230, 170, 0.30);
      --selectedStroke: rgba(160, 255, 210, 0.70);

      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.70);

      --callLine: rgba(255,255,255,0.42);
      --callBoxFront: rgba(255,255,255,0.10);
      --callBoxBack: rgba(255,255,255,0.18);
      --callBoxStroke: rgba(255,255,255,0.35);
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(1200px 800px at 20% 10%, #13204a 0%, var(--bg) 60%);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
    }

    .wrap{ width:min(1180px, 96vw); padding:18px 14px 24px; }

    .header{
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:0 12px 30px rgba(0,0,0,0.25);
      backdrop-filter:blur(10px);
    }

    h1{ font-size:18px; margin:0 0 6px 0; letter-spacing:0.2px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.35; margin:0; }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.08);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:transform 0.08s ease, background 0.2s ease;
      user-select:none;
    }
    button:hover{ background:rgba(255,255,255,0.12); }
    button:active{ transform:translateY(1px); }

    .status{
      font-size:13px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.12);
    }

    .mapFrame{
      margin-top:12px;
      background:rgba(0,0,0,0.16);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }

    svg{ width:100%; height:auto; display:block; }

    /* --- State cards (no 3D rotate so text never mirrors) --- */
    .state-card{ cursor:pointer; transform-box: fill-box; transform-origin: center; }

    .state-card .front-shape,
    .state-card .back-shape{
      stroke:var(--stroke);
      stroke-width:0.85;
      vector-effect:non-scaling-stroke;
      transition: fill 220ms ease, stroke 220ms ease, opacity 180ms ease, filter 220ms ease;
    }

    .state-card .front-shape{ fill:var(--front); opacity:1; }
    .state-card:hover .front-shape{ fill:var(--frontHover); }

    .state-card .back-shape{ fill:var(--back); opacity:0; }

    .state-card .label,
    .state-card .sub{
      font-weight:800;
      letter-spacing:0.3px;
      fill:rgba(255,255,255,0.92);
      paint-order:stroke;
      stroke:rgba(0,0,0,0.55);
      stroke-width:2.5;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms ease;
    }
    .state-card .sub{
      font-weight:700;
      stroke-width:2.0;
      fill:rgba(255,255,255,0.86);
    }

    .state-card.flipped .front-shape{ opacity:0; }
    .state-card.flipped .back-shape{ opacity:1; }
    .state-card.flipped .label,
    .state-card.flipped .sub{ opacity:1; }

    /* Selected color + subtle glow */
    .state-card.selected .front-shape{ fill: var(--selectedFront); stroke: var(--selectedStroke); }
    .state-card.selected .back-shape{ fill:  var(--selectedBack);  stroke: var(--selectedStroke); }
    .state-card.selected .front-shape,
    .state-card.selected .back-shape{
      filter: drop-shadow(0 10px 16px rgba(0,0,0,0.35));
    }

    /* Click animation */
    @keyframes pop {
      0%   { transform: scale(1); }
      45%  { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .state-card.popped{ animation: pop 260ms ease-out; }

    /* --- Callouts for tiny states --- */
    .callout-line{
      stroke: var(--callLine);
      stroke-width: 1.2;
      vector-effect: non-scaling-stroke;
      fill: none;
    }

    .callout-card{ cursor: pointer; transform-box: fill-box; transform-origin: center; }
    .callout-front, .callout-back{
      stroke: var(--callBoxStroke);
      stroke-width: 1;
      vector-effect: non-scaling-stroke;
      transition: opacity 180ms ease, fill 220ms ease, stroke 220ms ease, filter 220ms ease;
    }
    .callout-front{ fill: var(--callBoxFront); opacity: 1; }
    .callout-back { fill: var(--callBoxBack);  opacity: 0; }

    /* Front shows NOTHING before clicking */
    .callout-text-front{
      opacity: 0;
      pointer-events: none;
      user-select: none;
    }

    /* Back shows Name + Initials (no parentheses) */
    .callout-text-back{
      font-weight: 800;
      fill: rgba(255,255,255,0.92);
      paint-order: stroke;
      stroke: rgba(0,0,0,0.55);
      stroke-width: 2.2;
      pointer-events: none;
      user-select: none;
      transition: opacity 180ms ease;
      opacity: 0;
    }

    .callout-card.flipped .callout-front{ opacity: 0; }
    .callout-card.flipped .callout-back { opacity: 1; }
    .callout-card.flipped .callout-text-back { opacity: 1; }

    .callout-card.selected .callout-front,
    .callout-card.selected .callout-back{
      fill: var(--selectedBack);
      stroke: var(--selectedStroke);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.35));
    }

    .error{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,80,80,0.14);
      border:1px solid rgba(255,80,80,0.35);
      color:rgba(255,255,255,0.92);
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="card">
        <h1>US States Flashcard Map</h1>
        <p class="hint">
          Click a state to reveal its <b>name</b> + <b>initials</b>.<br/>
          Tiny states: click the blank <b>callout squares</b> on the right.
        </p>
      </div>

      <div class="controls card">
        <button id="resetBtn" type="button">Reset</button>
        <button id="randomBtn" type="button">Random state</button>
        <div class="status" id="status">Loading map…</div>
      </div>
    </div>

    <div class="mapFrame">
      <svg id="map" viewBox="0 0 1100 620" aria-label="Map of the United States showing states as flip cards" role="img"></svg>
    </div>

    <div class="error" id="errorBox"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script>
    const FIPS = {
      "01": { name: "Alabama", abbr: "AL" }, "02": { name: "Alaska", abbr: "AK" },
      "04": { name: "Arizona", abbr: "AZ" }, "05": { name: "Arkansas", abbr: "AR" },
      "06": { name: "California", abbr: "CA" }, "08": { name: "Colorado", abbr: "CO" },
      "09": { name: "Connecticut", abbr: "CT" }, "10": { name: "Delaware", abbr: "DE" },
      "11": { name: "District of Columbia", abbr: "DC" }, "12": { name: "Florida", abbr: "FL" },
      "13": { name: "Georgia", abbr: "GA" }, "15": { name: "Hawaii", abbr: "HI" },
      "16": { name: "Idaho", abbr: "ID" }, "17": { name: "Illinois", abbr: "IL" },
      "18": { name: "Indiana", abbr: "IN" }, "19": { name: "Iowa", abbr: "IA" },
      "20": { name: "Kansas", abbr: "KS" }, "21": { name: "Kentucky", abbr: "KY" },
      "22": { name: "Louisiana", abbr: "LA" }, "23": { name: "Maine", abbr: "ME" },
      "24": { name: "Maryland", abbr: "MD" }, "25": { name: "Massachusetts", abbr: "MA" },
      "26": { name: "Michigan", abbr: "MI" }, "27": { name: "Minnesota", abbr: "MN" },
      "28": { name: "Mississippi", abbr: "MS" }, "29": { name: "Missouri", abbr: "MO" },
      "30": { name: "Montana", abbr: "MT" }, "31": { name: "Nebraska", abbr: "NE" },
      "32": { name: "Nevada", abbr: "NV" }, "33": { name: "New Hampshire", abbr: "NH" },
      "34": { name: "New Jersey", abbr: "NJ" }, "35": { name: "New Mexico", abbr: "NM" },
      "36": { name: "New York", abbr: "NY" }, "37": { name: "North Carolina", abbr: "NC" },
      "38": { name: "North Dakota", abbr: "ND" }, "39": { name: "Ohio", abbr: "OH" },
      "40": { name: "Oklahoma", abbr: "OK" }, "41": { name: "Oregon", abbr: "OR" },
      "42": { name: "Pennsylvania", abbr: "PA" }, "44": { name: "Rhode Island", abbr: "RI" },
      "45": { name: "South Carolina", abbr: "SC" }, "46": { name: "South Dakota", abbr: "SD" },
      "47": { name: "Tennessee", abbr: "TN" }, "48": { name: "Texas", abbr: "TX" },
      "49": { name: "Utah", abbr: "UT" }, "50": { name: "Vermont", abbr: "VT" },
      "51": { name: "Virginia", abbr: "VA" }, "53": { name: "Washington", abbr: "WA" },
      "54": { name: "West Virginia", abbr: "WV" }, "55": { name: "Wisconsin", abbr: "WI" },
      "56": { name: "Wyoming", abbr: "WY" }
    };

    // Tiny / hard-to-click states -> use callouts ONLY for labels
    const TINY_ABBR = ["DC","RI","DE","CT","NJ","MA","MD","VT","NH"];
    const TINY = new Set(TINY_ABBR);

    const statusEl = document.getElementById("status");
    const errorBox = document.getElementById("errorBox");
    const svg = d3.select("#map");

    let statesData = [];
    let metaByAbbr = new Map();
    let stateSelByAbbr = new Map();
    let calloutSelByAbbr = new Map();

    function setStatus(msg){ statusEl.textContent = msg; }
    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      setStatus("Couldn’t load map");
    }
    function raiseToTop(el){ el.parentNode.appendChild(el); }

    function popSelection(sel){
      sel.classed("popped", true);
      setTimeout(() => sel.classed("popped", false), 280);
    }

    // Toggle ON/OFF so clicking again fully resets the state
    function toggleState(abbr, forceOn = null){
      const s = stateSelByAbbr.get(abbr);
      if (!s) return;

      const isOn = s.classed("selected") || s.classed("flipped");
      const nextOn = (forceOn === null) ? !isOn : !!forceOn;

      // For tiny states: never show labels on the state itself.
      // We still color-highlight the state for feedback.
      const showStateText = !TINY.has(abbr);

      s.classed("selected", nextOn);

      if (showStateText) {
        s.classed("flipped", nextOn);
      } else {
        // ensure no state text appears
        s.classed("flipped", false);
      }

      popSelection(s);

      // Sync callout if present
      const c = calloutSelByAbbr.get(abbr);
      if (c){
        c.classed("selected", nextOn);
        c.classed("flipped", nextOn);
        popSelection(c);
      }

      const meta = metaByAbbr.get(abbr);
      setStatus(nextOn ? `✅ ${meta.name} ${abbr}` : "Click a state");
    }

    function resetAll(){
      for (const [abbr, s] of stateSelByAbbr.entries()){
        s.classed("flipped", false).classed("selected", false);
      }
      for (const [abbr, c] of calloutSelByAbbr.entries()){
        c.classed("flipped", false).classed("selected", false);
      }
      setStatus("Click a state");
    }

    async function init(){
      try{
        setStatus("Loading map…");

        const topo = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
        const states = topojson.feature(topo, topo.objects.states).features;

        statesData = states
          .map(f => {
            const id2 = String(f.id).padStart(2,"0");
            return { ...f, id2, meta: FIPS[id2] || null };
          })
          .filter(f => f.meta);

        // Layout: leave room on right for callouts
        const projection = d3.geoAlbersUsa();
        projection.fitExtent([[20,20],[900,600]], { type:"FeatureCollection", features: statesData });
        const path = d3.geoPath(projection);

        const root = svg.append("g").attr("id","root");
        const statesLayer = root.append("g").attr("id","statesLayer");
        const calloutLayer = root.append("g").attr("id","calloutLayer");

        // Draw states
        const groups = statesLayer.selectAll("g.state-card")
          .data(statesData)
          .join("g")
          .attr("class","state-card")
          .attr("data-abbr", d => d.meta.abbr)
          .on("mouseenter", function(){ raiseToTop(this); })
          .on("click", function(event, d){
            toggleState(d.meta.abbr);
          });

        groups.append("path")
          .attr("class","front-shape")
          .attr("d", d => path(d));

        groups.append("path")
          .attr("class","back-shape")
          .attr("d", d => path(d));

        // Labels: ONLY for non-tiny states
        groups.each(function(d){
          const abbr = d.meta.abbr;
          if (TINY.has(abbr)) return; // no state text at all for tiny states

          const [cx, cy] = path.centroid(d);
          const name = d.meta.name;

          const nameSize =
            name.length <= 10 ? 13 :
            name.length <= 14 ? 12 :
            name.length <= 18 ? 11 : 10;

          const node = d3.select(this);

          node.append("text")
            .attr("class","label")
            .attr("x", cx).attr("y", cy - 2)
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .style("font-size", nameSize + "px")
            .text(name);

          node.append("text")
            .attr("class","sub")
            .attr("x", cx).attr("y", cy + 14)
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .style("font-size","12px")
            .text(abbr); // NO parentheses
        });

        // Index lookups
        statesData.forEach(d => metaByAbbr.set(d.meta.abbr, d.meta));
        groups.each(function(d){ stateSelByAbbr.set(d.meta.abbr, d3.select(this)); });

        // AK/HI: standard inset positions (bottom-left outside mainland)
        function moveStateInset(abbr, targetX, targetY, scale=1){
          const sel = stateSelByAbbr.get(abbr);
          if (!sel) return;

          const node = sel.node();
          const bbox = node.getBBox();
          const cx = bbox.x + bbox.width/2;
          const cy = bbox.y + bbox.height/2;

          const dx = targetX - cx;
          const dy = targetY - cy;

          sel.attr("transform", `translate(${dx},${dy}) scale(${scale})`);
        }
        moveStateInset("AK", 150, 520, 0.92);
        moveStateInset("HI", 320, 525, 1.00);

        // --- Callouts for tiny states: lines + blank squares; reveal Name + Initials on click ---
        const tinyFeatures = statesData
          .filter(d => TINY.has(d.meta.abbr))
          .map(d => {
            const c = path.centroid(d);
            return { abbr: d.meta.abbr, name: d.meta.name, cx: c[0], cy: c[1] };
          })
          .sort((a,b) => a.cy - b.cy);

        const anchorX = 1015;
        const minY = 90, maxY = 420;
        const step = 30;

        let lastY = -Infinity;
        tinyFeatures.forEach(t => {
          let y = Math.max(minY, Math.min(maxY, t.cy));
          if (y < lastY + step) y = lastY + step;
          lastY = y;
          t.ay = y;
          t.ax = anchorX;
        });

        calloutLayer.selectAll("path.callout-line")
          .data(tinyFeatures)
          .join("path")
          .attr("class","callout-line")
          .attr("d", d => {
            const midX = 935;
            return `M ${d.cx} ${d.cy} L ${midX} ${d.cy} L ${midX} ${d.ay} L ${d.ax - 18} ${d.ay}`;
          });

        const boxW = 120, boxH = 34;

        const callouts = calloutLayer.selectAll("g.callout-card")
          .data(tinyFeatures)
          .join("g")
          .attr("class","callout-card")
          .attr("data-abbr", d => d.abbr)
          .attr("transform", d => `translate(${d.ax},${d.ay})`)
          .on("mouseenter", function(){ raiseToTop(this); })
          .on("click", function(event, d){
            toggleState(d.abbr);
          });

        callouts.append("rect")
          .attr("class","callout-front")
          .attr("x", 0)
          .attr("y", -boxH/2)
          .attr("width", boxW)
          .attr("height", boxH)
          .attr("rx", 8).attr("ry", 8);

        callouts.append("rect")
          .attr("class","callout-back")
          .attr("x", 0)
          .attr("y", -boxH/2)
          .attr("width", boxW)
          .attr("height", boxH)
          .attr("rx", 8).attr("ry", 8);

        // Front text exists but is invisible (so "nothing before clicking")
        callouts.append("text")
          .attr("class","callout-text-front")
          .attr("x", boxW/2)
          .attr("y", 0)
          .attr("text-anchor","middle")
          .attr("dominant-baseline","central")
          .text("");

        // Back text (two lines): Name then Initials (no parentheses)
        callouts.append("text")
          .attr("class","callout-text-back")
          .attr("x", 10)
          .attr("y", -2)
          .attr("text-anchor","start")
          .attr("dominant-baseline","central")
          .each(function(d){
            const t = d3.select(this);

            // Slight shortening for very long names
            const name = d.name.length > 16 ? d.name.slice(0, 15) + "…" : d.name;

            t.append("tspan")
              .attr("x", 10)
              .attr("dy", 0)
              .text(name);

            t.append("tspan")
              .attr("x", 10)
              .attr("dy", 14)
              .style("font-weight", 900)
              .text(d.abbr);
          });

        callouts.each(function(d){
          calloutSelByAbbr.set(d.abbr, d3.select(this));
        });

        setStatus("Click a state");
      } catch (err){
        console.error(err);
        showError(
          "This page needs internet access to load map data (us-atlas) and D3.\n" +
          "If you’re offline, reopen when connected."
        );
      }
    }

    document.getElementById("resetBtn").addEventListener("click", resetAll);

    document.getElementById("randomBtn").addEventListener("click", () => {
      if (!statesData.length) return;
      const pick = statesData[Math.floor(Math.random() * statesData.length)].meta.abbr;
      toggleState(pick, true);
    });

    init();
  </script>
</body>
</html>
