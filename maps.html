<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US States Flip Map</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.35);
      --front: rgba(255,255,255,0.10);
      --frontHover: rgba(255,255,255,0.18);
      --back: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 10%, #13204a 0%, var(--bg) 60%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
    }

    .wrap {
      width: min(1100px, 96vw);
      padding: 18px 14px 24px;
    }

    .header {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .card {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
    }

    h1 {
      font-size: 18px;
      margin: 0 0 6px 0;
      letter-spacing: 0.2px;
    }

    .hint {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      margin: 0;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform 0.08s ease, background 0.2s ease;
      user-select: none;
    }
    button:hover { background: rgba(255,255,255,0.12); }
    button:active { transform: translateY(1px); }

    .status {
      font-size: 13px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.12);
    }

    .mapFrame {
      margin-top: 12px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* --- State "flashcards" --- */
    .state-card {
      cursor: pointer;
      transform-box: fill-box;
      transform-origin: center;
      transition: transform 560ms cubic-bezier(.2,.8,.2,1);
      /* Helps some browsers with SVG transforms */
      will-change: transform;
    }

    .state-card .front-shape,
    .state-card .back-shape {
      stroke: var(--stroke);
      stroke-width: 0.8;
      vector-effect: non-scaling-stroke;
    }

    .state-card .front-shape {
      fill: var(--front);
      transition: fill 200ms ease;
    }

    .state-card:hover .front-shape { fill: var(--frontHover); }

    /* Back side */
    .state-card .back-shape {
      fill: var(--back);
      opacity: 0;
      transition: opacity 180ms ease;
    }

    .state-card .label {
      font-weight: 800;
      letter-spacing: 0.3px;
      fill: rgba(255,255,255,0.92);
      paint-order: stroke;
      stroke: rgba(0,0,0,0.55);
      stroke-width: 2.5;
      opacity: 0;
      pointer-events: none;
    }
    .state-card .sub {
      font-weight: 700;
      fill: rgba(255,255,255,0.86);
      paint-order: stroke;
      stroke: rgba(0,0,0,0.50);
      stroke-width: 2.0;
      opacity: 0;
      pointer-events: none;
    }

    /* ‚ÄúFlip‚Äù effect (works in modern browsers). We also gate visibility via opacity. */
    .state-card.flipped { transform: rotateY(180deg); }
    .state-card.flipped .front-shape { opacity: 0; }
    .state-card.flipped .back-shape { opacity: 1; }
    .state-card.flipped .label,
    .state-card.flipped .sub { opacity: 1; }

    /* --- Hover-zoom for small states --- */
    .state-card.small {
      transition: transform 300ms cubic-bezier(.2,.8,.2,1);
    }
    .state-card.small:hover {
      transform: scale(2.2);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.45));
    }
    .state-card.small.flipped:hover {
      transform: rotateY(180deg) scale(2.2);
    }

    /* Make sure hovered state draws on top */
    .state-card.raised { }

    /* Tooltip-like helper for tiny states */
    .tinyHelp {
      position: absolute;
      right: 12px;
      bottom: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      padding: 8px 10px;
      user-select: none;
      pointer-events: none;
    }

    .error {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,80,80,0.14);
      border: 1px solid rgba(255,80,80,0.35);
      color: rgba(255,255,255,0.92);
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="card">
        <h1>US States Flashcard Map</h1>
        <p class="hint">
          Click a state to ‚Äúflip‚Äù and reveal its <b>name</b> + <b>abbreviation</b>.<br/>
          Tiny states zoom on hover for easier clicking.
        </p>
      </div>

      <div class="controls card">
        <button id="resetBtn" type="button">Reset (unflip all)</button>
        <button id="randomBtn" type="button">Random state</button>
        <div class="status" id="status">Loading map‚Ä¶</div>
      </div>
    </div>

    <div class="mapFrame">
      <svg id="map" viewBox="0 0 1000 620" aria-label="Map of the United States showing states as flip cards" role="img"></svg>
      <div class="tinyHelp">Tip: hover tiny states to zoom üîç</div>
    </div>

    <div class="error" id="errorBox"></div>
  </div>

  <!-- Uses public US Atlas topojson and D3 from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script>
    // FIPS -> { name, abbr }
    // Source for FIPS codes is standard; map shapes come from us-atlas states-10m.
    const FIPS = {
      "01": { name: "Alabama", abbr: "AL" },
      "02": { name: "Alaska", abbr: "AK" },
      "04": { name: "Arizona", abbr: "AZ" },
      "05": { name: "Arkansas", abbr: "AR" },
      "06": { name: "California", abbr: "CA" },
      "08": { name: "Colorado", abbr: "CO" },
      "09": { name: "Connecticut", abbr: "CT" },
      "10": { name: "Delaware", abbr: "DE" },
      "11": { name: "District of Columbia", abbr: "DC" },
      "12": { name: "Florida", abbr: "FL" },
      "13": { name: "Georgia", abbr: "GA" },
      "15": { name: "Hawaii", abbr: "HI" },
      "16": { name: "Idaho", abbr: "ID" },
      "17": { name: "Illinois", abbr: "IL" },
      "18": { name: "Indiana", abbr: "IN" },
      "19": { name: "Iowa", abbr: "IA" },
      "20": { name: "Kansas", abbr: "KS" },
      "21": { name: "Kentucky", abbr: "KY" },
      "22": { name: "Louisiana", abbr: "LA" },
      "23": { name: "Maine", abbr: "ME" },
      "24": { name: "Maryland", abbr: "MD" },
      "25": { name: "Massachusetts", abbr: "MA" },
      "26": { name: "Michigan", abbr: "MI" },
      "27": { name: "Minnesota", abbr: "MN" },
      "28": { name: "Mississippi", abbr: "MS" },
      "29": { name: "Missouri", abbr: "MO" },
      "30": { name: "Montana", abbr: "MT" },
      "31": { name: "Nebraska", abbr: "NE" },
      "32": { name: "Nevada", abbr: "NV" },
      "33": { name: "New Hampshire", abbr: "NH" },
      "34": { name: "New Jersey", abbr: "NJ" },
      "35": { name: "New Mexico", abbr: "NM" },
      "36": { name: "New York", abbr: "NY" },
      "37": { name: "North Carolina", abbr: "NC" },
      "38": { name: "North Dakota", abbr: "ND" },
      "39": { name: "Ohio", abbr: "OH" },
      "40": { name: "Oklahoma", abbr: "OK" },
      "41": { name: "Oregon", abbr: "OR" },
      "42": { name: "Pennsylvania", abbr: "PA" },
      "44": { name: "Rhode Island", abbr: "RI" },
      "45": { name: "South Carolina", abbr: "SC" },
      "46": { name: "South Dakota", abbr: "SD" },
      "47": { name: "Tennessee", abbr: "TN" },
      "48": { name: "Texas", abbr: "TX" },
      "49": { name: "Utah", abbr: "UT" },
      "50": { name: "Vermont", abbr: "VT" },
      "51": { name: "Virginia", abbr: "VA" },
      "53": { name: "Washington", abbr: "WA" },
      "54": { name: "West Virginia", abbr: "WV" },
      "55": { name: "Wisconsin", abbr: "WI" },
      "56": { name: "Wyoming", abbr: "WY" }
    };

    // Which ones should hover-zoom (tiny, clustered in NE corridor)
    const TINY = new Set(["CT","RI","NJ","DE","MD","MA","VT","NH","DC"]);

    const statusEl = document.getElementById("status");
    const errorBox = document.getElementById("errorBox");
    const svg = d3.select("#map");

    // Keep a list of state <g> selections for reset/random
    let stateGroups = [];
    let statesData = [];

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      statusEl.textContent = "Couldn‚Äôt load map";
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // Bring hovered element to top so zoom doesn't get hidden
    function raiseToTop(el) {
      el.parentNode.appendChild(el);
    }

    async function init() {
      try {
        setStatus("Loading map‚Ä¶");

        // Public topojson file containing US states geometry
        const topo = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");

        // Convert topojson to geojson features
        const states = topojson.feature(topo, topo.objects.states).features;

        // Some datasets include territories; keep only those we have in FIPS map
        statesData = states
          .map(f => {
            const id = String(f.id).padStart(2, "0");
            return { ...f, id2: id, meta: FIPS[id] || null };
          })
          .filter(f => f.meta);

        // Setup projection and path generator (Albers USA includes AK/HI insets)
        const projection = d3.geoAlbersUsa();
        projection.fitExtent([[20, 20], [980, 600]], { type: "FeatureCollection", features: statesData });

        const path = d3.geoPath(projection);

        // Draw each state as a "card" group with front/back shapes and labels
        const gRoot = svg.append("g");

        const groups = gRoot
          .selectAll("g.state-card")
          .data(statesData)
          .join("g")
          .attr("class", d => {
            const abbr = d.meta.abbr;
            return `state-card${TINY.has(abbr) ? " small" : ""}`;
          })
          .attr("data-name", d => d.meta.name)
          .attr("data-abbr", d => d.meta.abbr)
          .on("mouseenter", function() {
            // raise hovered state to top (helps zoomed tiny states)
            raiseToTop(this);
          })
          .on("click", function(event, d) {
            // Toggle flipped state
            const node = d3.select(this);
            const isFlipped = node.classed("flipped");
            node.classed("flipped", !isFlipped);

            const name = d.meta.name;
            const abbr = d.meta.abbr;
            setStatus(!isFlipped ? `‚úÖ ${name} (${abbr})` : "Click a state");
          });

        // Front shape
        groups.append("path")
          .attr("class", "front-shape")
          .attr("d", d => path(d));

        // Back shape (same geometry)
        groups.append("path")
          .attr("class", "back-shape")
          .attr("d", d => path(d));

        // Labels on back: state name + abbreviation
        // For readability, we use centroid; tiny states still work due to zoom.
        groups.each(function(d) {
          const [cx, cy] = path.centroid(d);
          const name = d.meta.name;
          const abbr = d.meta.abbr;

          const node = d3.select(this);

          // Name (smaller for long names)
          const nameSize =
            name.length <= 10 ? 13 :
            name.length <= 14 ? 12 :
            name.length <= 18 ? 11 : 10;

          node.append("text")
            .attr("class", "label")
            .attr("x", cx)
            .attr("y", cy - 2)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .style("font-size", nameSize + "px")
            .text(name);

          node.append("text")
            .attr("class", "sub")
            .attr("x", cx)
            .attr("y", cy + 14)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .style("font-size", "12px")
            .text("(" + abbr + ")");
        });

        stateGroups = groups.nodes().map(n => d3.select(n));

        setStatus("Click a state");
      } catch (err) {
        console.error(err);
        showError(
          "This page needs internet access the first time to load the map data (us-atlas) and D3.\n" +
          "If you‚Äôre offline, reopen when connected."
        );
      }
    }

    // Controls
    document.getElementById("resetBtn").addEventListener("click", () => {
      stateGroups.forEach(s => s.classed("flipped", false));
      setStatus("Click a state");
    });

    document.getElementById("randomBtn").addEventListener("click", () => {
      if (!statesData.length) return;
      const pick = statesData[Math.floor(Math.random() * statesData.length)];
      const abbr = pick.meta.abbr;

      // Find corresponding group and flip it
      const node = d3.selectAll("g.state-card")
        .filter(d => d.meta && d.meta.abbr === abbr)
        .node();

      if (node) {
        raiseToTop(node);
        const sel = d3.select(node);
        sel.classed("flipped", true);
        setStatus(`üéØ ${pick.meta.name} (${abbr})`);
      }
    });

    init();
  </script>
</body>
</html>
