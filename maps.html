<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US States Flip Map</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,0.06);
      --stroke:rgba(255,255,255,0.35);
      --front:rgba(255,255,255,0.10);
      --frontHover:rgba(255,255,255,0.18);
      --back:rgba(255,255,255,0.16);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.70);
      --lens:rgba(255,255,255,0.10);
      --lensStroke:rgba(255,255,255,0.30);
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(1200px 800px at 20% 10%, #13204a 0%, var(--bg) 60%);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
    }

    .wrap{ width:min(1100px, 96vw); padding:18px 14px 24px; }

    .header{
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:0 12px 30px rgba(0,0,0,0.25);
      backdrop-filter:blur(10px);
    }

    h1{ font-size:18px; margin:0 0 6px 0; letter-spacing:0.2px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.35; margin:0; }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.08);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:transform 0.08s ease, background 0.2s ease;
      user-select:none;
    }
    button:hover{ background:rgba(255,255,255,0.12); }
    button:active{ transform:translateY(1px); }

    .status{
      font-size:13px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.12);
    }

    .mapFrame{
      margin-top:12px;
      background:rgba(0,0,0,0.16);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }

    svg{ width:100%; height:auto; display:block; }

    /* --- State "flashcards" (no 3D rotate, so text never mirrors) --- */
    .state-card{ cursor:pointer; }
    .state-card .front-shape,
    .state-card .back-shape{
      stroke:var(--stroke);
      stroke-width:0.8;
      vector-effect:non-scaling-stroke;
    }
    .state-card .front-shape{
      fill:var(--front);
      transition:fill 200ms ease, opacity 180ms ease;
      opacity:1;
    }
    .state-card:hover .front-shape{ fill:var(--frontHover); }

    .state-card .back-shape{
      fill:var(--back);
      opacity:0;
      transition:opacity 180ms ease;
    }

    .state-card .label,
    .state-card .sub{
      font-weight:800;
      letter-spacing:0.3px;
      fill:rgba(255,255,255,0.92);
      paint-order:stroke;
      stroke:rgba(0,0,0,0.55);
      stroke-width:2.5;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms ease;
    }
    .state-card .sub{
      font-weight:700;
      stroke-width:2.0;
      fill:rgba(255,255,255,0.86);
    }

    .state-card.flipped .front-shape{ opacity:0; }
    .state-card.flipped .back-shape{ opacity:1; }
    .state-card.flipped .label,
    .state-card.flipped .sub{ opacity:1; }

    /* --- Northeast Lens (zoom whole region) --- */
    .lens-rect{
      fill:var(--lens);
      stroke:var(--lensStroke);
      stroke-width:1.2;
      vector-effect:non-scaling-stroke;
      rx:10;
      ry:10;
      cursor:zoom-in;
    }
    .lens-label{
      font-size:12px;
      font-weight:700;
      fill:rgba(255,255,255,0.78);
      paint-order:stroke;
      stroke:rgba(0,0,0,0.45);
      stroke-width:2.0;
      pointer-events:none;
      user-select:none;
    }

    .tinyHelp{
      position:absolute;
      right:12px;
      bottom:12px;
      font-size:12px;
      color:rgba(255,255,255,0.78);
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:12px;
      padding:8px 10px;
      user-select:none;
      pointer-events:none;
    }

    .error{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,80,80,0.14);
      border:1px solid rgba(255,80,80,0.35);
      color:rgba(255,255,255,0.92);
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="card">
        <h1>US States Flashcard Map</h1>
        <p class="hint">
          Click a state to reveal its <b>name</b> + <b>abbreviation</b>.<br/>
          Hover the <b>Northeast Zoom</b> box to enlarge the tiny states.
        </p>
      </div>

      <div class="controls card">
        <button id="resetBtn" type="button">Reset (unflip all)</button>
        <button id="randomBtn" type="button">Random state</button>
        <div class="status" id="status">Loading map‚Ä¶</div>
      </div>
    </div>

    <div class="mapFrame">
      <svg id="map" viewBox="0 0 1000 620" aria-label="Map of the United States showing states as flip cards" role="img"></svg>
      <div class="tinyHelp">Tip: hover ‚ÄúNortheast Zoom‚Äù to magnify the tiny states üîç</div>
    </div>

    <div class="error" id="errorBox"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script>
    const FIPS = {
      "01": { name: "Alabama", abbr: "AL" }, "02": { name: "Alaska", abbr: "AK" },
      "04": { name: "Arizona", abbr: "AZ" }, "05": { name: "Arkansas", abbr: "AR" },
      "06": { name: "California", abbr: "CA" }, "08": { name: "Colorado", abbr: "CO" },
      "09": { name: "Connecticut", abbr: "CT" }, "10": { name: "Delaware", abbr: "DE" },
      "11": { name: "District of Columbia", abbr: "DC" }, "12": { name: "Florida", abbr: "FL" },
      "13": { name: "Georgia", abbr: "GA" }, "15": { name: "Hawaii", abbr: "HI" },
      "16": { name: "Idaho", abbr: "ID" }, "17": { name: "Illinois", abbr: "IL" },
      "18": { name: "Indiana", abbr: "IN" }, "19": { name: "Iowa", abbr: "IA" },
      "20": { name: "Kansas", abbr: "KS" }, "21": { name: "Kentucky", abbr: "KY" },
      "22": { name: "Louisiana", abbr: "LA" }, "23": { name: "Maine", abbr: "ME" },
      "24": { name: "Maryland", abbr: "MD" }, "25": { name: "Massachusetts", abbr: "MA" },
      "26": { name: "Michigan", abbr: "MI" }, "27": { name: "Minnesota", abbr: "MN" },
      "28": { name: "Mississippi", abbr: "MS" }, "29": { name: "Missouri", abbr: "MO" },
      "30": { name: "Montana", abbr: "MT" }, "31": { name: "Nebraska", abbr: "NE" },
      "32": { name: "Nevada", abbr: "NV" }, "33": { name: "New Hampshire", abbr: "NH" },
      "34": { name: "New Jersey", abbr: "NJ" }, "35": { name: "New Mexico", abbr: "NM" },
      "36": { name: "New York", abbr: "NY" }, "37": { name: "North Carolina", abbr: "NC" },
      "38": { name: "North Dakota", abbr: "ND" }, "39": { name: "Ohio", abbr: "OH" },
      "40": { name: "Oklahoma", abbr: "OK" }, "41": { name: "Oregon", abbr: "OR" },
      "42": { name: "Pennsylvania", abbr: "PA" }, "44": { name: "Rhode Island", abbr: "RI" },
      "45": { name: "South Carolina", abbr: "SC" }, "46": { name: "South Dakota", abbr: "SD" },
      "47": { name: "Tennessee", abbr: "TN" }, "48": { name: "Texas", abbr: "TX" },
      "49": { name: "Utah", abbr: "UT" }, "50": { name: "Vermont", abbr: "VT" },
      "51": { name: "Virginia", abbr: "VA" }, "53": { name: "Washington", abbr: "WA" },
      "54": { name: "West Virginia", abbr: "WV" }, "55": { name: "Wisconsin", abbr: "WI" },
      "56": { name: "Wyoming", abbr: "WY" }
    };

    const statusEl = document.getElementById("status");
    const errorBox = document.getElementById("errorBox");
    const svg = d3.select("#map");

    let statesData = [];
    let stateGroups = [];

    function setStatus(msg){ statusEl.textContent = msg; }
    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      setStatus("Couldn‚Äôt load map");
    }

    function raiseToTop(el){ el.parentNode.appendChild(el); }

    async function init(){
      try{
        setStatus("Loading map‚Ä¶");

        const topo = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
        const states = topojson.feature(topo, topo.objects.states).features;

        statesData = states
          .map(f => {
            const id2 = String(f.id).padStart(2,"0");
            return { ...f, id2, meta: FIPS[id2] || null };
          })
          .filter(f => f.meta);

        const projection = d3.geoAlbersUsa();
        projection.fitExtent([[20,20],[980,600]], { type:"FeatureCollection", features: statesData });
        const path = d3.geoPath(projection);

        const root = svg.append("g").attr("id","root");

        // --- Main states layer ---
        const statesLayer = root.append("g").attr("id","statesLayer");

        const groups = statesLayer.selectAll("g.state-card")
          .data(statesData)
          .join("g")
          .attr("class","state-card")
          .attr("data-name", d => d.meta.name)
          .attr("data-abbr", d => d.meta.abbr)
          .on("mouseenter", function(){ raiseToTop(this); })
          .on("click", function(event, d){
            const node = d3.select(this);
            const isFlipped = node.classed("flipped");
            node.classed("flipped", !isFlipped);
            setStatus(!isFlipped ? `‚úÖ ${d.meta.name} (${d.meta.abbr})` : "Click a state");
          });

        groups.append("path")
          .attr("class","front-shape")
          .attr("d", d => path(d));

        groups.append("path")
          .attr("class","back-shape")
          .attr("d", d => path(d));

        groups.each(function(d){
          const [cx, cy] = path.centroid(d);
          const name = d.meta.name;
          const abbr = d.meta.abbr;

          const nameSize =
            name.length <= 10 ? 13 :
            name.length <= 14 ? 12 :
            name.length <= 18 ? 11 : 10;

          const node = d3.select(this);

          node.append("text")
            .attr("class","label")
            .attr("x", cx).attr("y", cy - 2)
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .style("font-size", nameSize + "px")
            .text(name);

          node.append("text")
            .attr("class","sub")
            .attr("x", cx).attr("y", cy + 14)
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .style("font-size","12px")
            .text("(" + abbr + ")");
        });

        // --- Reposition AK and HI manually ---
        // We translate the entire group to desired locations:
        // Alaska: top-left; Hawaii: middle-left.
        function moveState(abbr, targetX, targetY, scale=1){
          const sel = groups.filter(d => d.meta.abbr === abbr);
          if (sel.empty()) return;

          // Get current bbox in screen coords
          const node = sel.node();
          const bbox = node.getBBox();
          const cx = bbox.x + bbox.width/2;
          const cy = bbox.y + bbox.height/2;

          // Translate from current center to target point
          const dx = targetX - cx;
          const dy = targetY - cy;

          sel.attr("transform", `translate(${dx},${dy}) scale(${scale})`);
        }

        // These coordinates are within the SVG viewBox (1000 x 620).
        // You can tweak target positions if you want them slightly different.
        moveState("AK", 150, 110, 1); // top-left
        moveState("HI", 160, 310, 1); // middle-left

        // --- Northeast "lens" zoom ---
        // We'll define a rectangle covering the northeast cluster in the original map,
        // and on hover we temporarily scale up the states layer around a focus point.
        // This enlarges all tiny states together so you can click them easily.
        //
        // Lens rectangle (adjustable if you want more/less area):
        const lens = { x: 735, y: 120, w: 230, h: 200 };

        // Create lens overlay rectangle + label on top
        const lensLayer = root.append("g").attr("id","lensLayer");

        lensLayer.append("rect")
          .attr("class","lens-rect")
          .attr("x", lens.x)
          .attr("y", lens.y)
          .attr("width", lens.w)
          .attr("height", lens.h);

        lensLayer.append("text")
          .attr("class","lens-label")
          .attr("x", lens.x + 12)
          .attr("y", lens.y + 20)
          .text("Northeast Zoom");

        // Zoom behavior: scale statesLayer around a focus point (center of lens)
        const focusX = lens.x + lens.w/2;
        const focusY = lens.y + lens.h/2;
        const zoomScale = 2.35;

        function applyZoom(on){
          // Transform around focus:
          // T(focus) * S(scale) * T(-focus)
          if (on){
            statesLayer
              .transition()
              .duration(180)
              .attr("transform", `translate(${focusX},${focusY}) scale(${zoomScale}) translate(${-focusX},${-focusY})`);
            setStatus("Zoomed Northeast ‚Äî click tiny states!");
          } else {
            statesLayer
              .transition()
              .duration(180)
              .attr("transform", null);
            setStatus("Click a state");
          }
        }

        // Trigger zoom when hovering lens area
        lensLayer
          .on("mouseenter", () => applyZoom(true))
          .on("mouseleave", () => applyZoom(false));

        stateGroups = groups.nodes().map(n => d3.select(n));

        setStatus("Click a state");
      } catch (err){
        console.error(err);
        showError(
          "This page needs internet access to load the map data (us-atlas) and D3.\n" +
          "If you‚Äôre offline, reopen when connected."
        );
      }
    }

    // Controls
    document.getElementById("resetBtn").addEventListener("click", () => {
      stateGroups.forEach(s => s.classed("flipped", false));
      setStatus("Click a state");
    });

    document.getElementById("randomBtn").addEventListener("click", () => {
      if (!statesData.length) return;
      const pick = statesData[Math.floor(Math.random() * statesData.length)];
      const abbr = pick.meta.abbr;

      const node = d3.selectAll("g.state-card")
        .filter(d => d.meta && d.meta.abbr === abbr)
        .node();

      if (node){
        raiseToTop(node);
        const sel = d3.select(node);
        sel.classed("flipped", true);
        setStatus(`üéØ ${pick.meta.name} (${abbr})`);
      }
    });

    init();
  </script>
</body>
</html>
