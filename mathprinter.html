<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
    <title>Math Worksheet Generator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            min-height: 100vh;
            padding-bottom: 40px;
        }
        .fredoka { 
            font-family: 'Fredoka One', cursive; 
            font-variant-numeric: tabular-nums; 
        }
        .app-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Configuration Cards */
        .config-section { 
            margin-bottom: 12px; 
            padding: 16px; 
            border-radius: 12px; 
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            border: 1px solid #e5e7eb;
        }

        /* Buttons */
        .option-btn { 
            transition: all 0.2s ease; 
            padding: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .option-btn small {
            font-weight: 400;
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        .option-btn:active { transform: scale(0.97); }
        .selected-btn { 
            background: #2563eb !important; 
            color:#fff !important; 
            border-color:#1d4ed8 !important; 
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        .option-btn:not(.selected-btn):hover { background-color: #f0f9ff; }

        /* Responsive Iframe Container */
        .iframe-container {
            width: 100%;
            height: 75vh; /* Takes up 75% of viewport height */
            background-color: #525659;
            border-radius: 8px;
            overflow: hidden;
        }
        #pdf-preview-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="app-container">
        <h1 class="text-2xl md:text-3xl fredoka text-slate-800 text-center mb-4">Math Worksheet Generator</h1>

        <div class="flex flex-col gap-3">
            
            <div id="range-section" class="config-section">
                <h3 class="text-md font-bold text-slate-700 mb-2">1. Select Range</h3>
                <div id="range-buttons" class="grid grid-cols-2 gap-3">
                    <button type="button" data-mode="operands-10" class="option-btn rounded-lg border border-gray-200 bg-gray-50 text-gray-600 selected-btn">
                        <span>Operands 1-10</span>
                        <small>(e.g. 10 + 10 = 20)</small>
                    </button>
                    <button type="button" data-mode="sums-20" class="option-btn rounded-lg border border-gray-200 bg-gray-50 text-gray-600">
                        <span>Sums up to 20</span>
                        <small>(e.g. 15 + 5 = 20)</small>
                    </button>
                </div>
            </div>

            <div id="operation-section" class="config-section">
                <h3 class="text-md font-bold text-slate-700 mb-2">2. Select Operation</h3>
                <div id="operation-buttons" class="grid grid-cols-3 gap-2">
                    <button type="button" data-op="+" class="option-btn rounded-lg border border-gray-200 bg-gray-50 text-gray-600 selected-btn">Addition</button>
                    <button type="button" data-op="-" class="option-btn rounded-lg border border-gray-200 bg-gray-50 text-gray-600">Subtract</button>
                    <button type="button" data-op="+-" class="option-btn rounded-lg border border-gray-200 bg-gray-50 text-gray-600">Both</button>
                </div>
            </div>

            <div class="config-section border-l-4 border-l-blue-500">
                <div class="text-center mb-4">
                    <p class="text-gray-600 text-sm uppercase tracking-wide font-semibold">Generating All Possible:</p>
                    <p id="stats-display" class="text-xl md:text-2xl font-bold text-blue-700 mt-1">
                        ...
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button id="generate-btn" class="bg-slate-800 text-white py-3 rounded-lg text-lg fredoka hover:bg-slate-900 active:scale-95 transition-transform shadow-md w-full">
                        Refresh / Shuffle
                    </button>
                    <button id="download-btn" class="bg-green-600 text-white py-3 rounded-lg text-lg fredoka hover:bg-green-700 active:scale-95 transition-transform shadow-md hidden w-full">
                        Download PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <h3 class="text-lg font-bold text-slate-700 mb-2 pl-1">PDF Preview</h3>
            <div class="iframe-container shadow-lg">
                <iframe id="pdf-preview-frame" title="PDF Preview"></iframe>
            </div>
        </div>
    </div>


    <script>
        const EQUATIONS_PER_PAGE = 60;
        
        // UI Elements
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const rangeButtons = document.getElementById('range-buttons');
        const operationButtons = document.getElementById('operation-buttons');
        const statsDisplay = document.getElementById('stats-display');
        const pdfFrame = document.getElementById('pdf-preview-frame');

        let lastGeneratedPDF = null;
        let lastFileName = "worksheet.pdf";
        let currentEquations = [];

        // Fisher-Yates Shuffle Algorithm to randomize the order
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Core Logic: Generate ALL Valid Combinations ---
        function generateUniverse(mode, opCode) {
            let equations = [];
            const addProblems = [];
            const subProblems = [];

            // 1. Generate ADDITION problems
            if (opCode.includes('+')) {
                if (mode === 'operands-10') {
                    // 1..10 + 1..10
                    for (let a = 1; a <= 10; a++) {
                        for (let b = 1; b <= 10; b++) {
                            addProblems.push(`${a} + ${b}`);
                        }
                    }
                } else {
                    // Sums up to 20 (A + B <= 20)
                    for (let a = 1; a <= 19; a++) {
                        for (let b = 1; b <= 19; b++) {
                            if (a + b <= 20) {
                                addProblems.push(`${a} + ${b}`);
                            }
                        }
                    }
                }
            }

            // 2. Generate SUBTRACTION problems
            if (opCode.includes('-')) {
                if (mode === 'operands-10') {
                    // Inverse of "Operands 1-10". 
                    // To keep it simple: Result 1..10, Subtrahend 1..10
                    // This implies Minuend is between 2 and 20.
                    for (let a = 2; a <= 20; a++) { // Minuend
                        for (let b = 1; b < a; b++) { // Subtrahend
                            let result = a - b;
                            // Check "Operands 1-10" feel: 
                            // Usually means we are testing single digit facts or facts derived from 10+10.
                            // We filter to ensure Subtrahend <= 10 AND Result <= 10
                            if (b <= 10 && result <= 10) {
                                subProblems.push(`${a} - ${b}`);
                            }
                        }
                    }
                } else {
                    // Sums up to 20 (Inverse) -> Minuend up to 20.
                    for (let a = 2; a <= 20; a++) {
                        for (let b = 1; b < a; b++) {
                            // Only constraint is result > 0 (handled by b < a)
                            subProblems.push(`${a} - ${b}`);
                        }
                    }
                }
            }

            // Combine and Shuffle
            equations = [...addProblems, ...subProblems];
            return shuffleArray(equations);
        }

        // --- Logic: Main Controller ---
        function updateApp() {
            const rangeBtn = document.querySelector('#range-buttons .selected-btn');
            const opBtn = document.querySelector('#operation-buttons .selected-btn');
            
            const mode = rangeBtn.dataset.mode;
            const opCode = opBtn.dataset.op;

            // 1. Generate All Equations
            currentEquations = generateUniverse(mode, opCode);
            
            // 2. Calculate Stats
            const totalEq = currentEquations.length;
            const totalPages = Math.ceil(totalEq / EQUATIONS_PER_PAGE);

            // 3. Update Text
            statsDisplay.innerHTML = `${totalEq} Equations <span class="text-gray-400 mx-2">|</span> ${totalPages} Pages`;

            // 4. Generate PDF
            generatePDFBlob(currentEquations, totalPages, mode);
        }

        // --- Logic: PDF Creation ---
        function generatePDFBlob(allEquations, numPages, mode) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            
            const margin = 40; 
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            const columnCount = 6;
            const rowCount = 10;
            const contentWidth = pageWidth - 2 * margin;
            const startY = margin + 40; 
            const contentHeight = pageHeight - startY - margin - 20;
            
            const equationWidth = contentWidth / columnCount; 
            const equationHeight = contentHeight / rowCount; 

            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0); 
            
            const titleText = mode === 'operands-10' ? "Operands 1-10" : "Sums up to 20";

            for (let pageNum = 0; pageNum < numPages; pageNum++) {
                if (pageNum > 0) doc.addPage();

                // Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(`Math Worksheet`, pageWidth / 2, margin + 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Difficulty: ${titleText}`, pageWidth / 2, margin + 30, { align: 'center' });
                
                doc.setLineWidth(1);
                doc.line(margin, startY, pageWidth - margin, startY);

                // Get equations for this page
                const startIndex = pageNum * EQUATIONS_PER_PAGE;
                const pageEquations = allEquations.slice(startIndex, startIndex + EQUATIONS_PER_PAGE);

                doc.setFontSize(12);
                
                // Render Equations
                pageEquations.forEach((eq, index) => {
                    const col = index % columnCount;
                    const row = Math.floor(index / columnCount);

                    const x = margin + (col * equationWidth) + 12; 
                    const y = startY + (row * equationHeight) + (equationHeight/1.6);
                    
                    const text = `${eq} =`;
                    doc.text(text, x, y);
                    
                    // Answer Line
                    const textWidth = doc.getTextWidth(text);
                    const lineStart = x + textWidth + 5;
                    const lineEnd = margin + ((col+1) * equationWidth) - 12; 
                    doc.setLineWidth(0.5);
                    doc.line(lineStart, y, lineEnd, y);
                });

                // Vertical Separator Lines
                doc.setLineWidth(0.5);
                const totalGridHeight = rowCount * equationHeight;
                for(let c = 1; c < columnCount; c++) {
                    const lineX = margin + (c * equationWidth);
                    doc.line(lineX, startY, lineX, startY + totalGridHeight);
                }

                // Bottom Border
                doc.setLineWidth(1);
                doc.line(margin, startY + totalGridHeight, pageWidth - margin, startY + totalGridHeight);

                // Footer
                doc.setFontSize(9);
                doc.text(`Page ${pageNum + 1} of ${numPages}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
            }

            lastGeneratedPDF = doc.output('bloburl');
            lastFileName = `math_worksheet_${mode}.pdf`;
            
            pdfFrame.src = lastGeneratedPDF;
            downloadBtn.classList.remove('hidden');
        }

        // --- Event Listeners ---
        function updateSelection(containerId, selectedElement) {
            document.getElementById(containerId).querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected-btn'));
            selectedElement.classList.add('selected-btn');
            updateApp(); // Auto trigger
        }

        rangeButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) updateSelection('range-buttons', btn);
        });

        operationButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) updateSelection('operation-buttons', btn);
        });

        generateBtn.addEventListener('click', updateApp); // Reshuffle

        downloadBtn.addEventListener('click', () => {
            if (lastGeneratedPDF) {
                const link = document.createElement('a');
                link.href = lastGeneratedPDF;
                link.download = lastFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateApp();
        });

    </script>
</body>
</html>
