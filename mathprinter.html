<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
    <title>Printable Math Worksheet Generator (Final Version)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation; 
            background-color: #f4f4f9; 
            min-height: 100vh;
        }
        .fredoka { 
            font-family: 'Fredoka One', cursive; 
            font-variant-numeric: tabular-nums; 
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }
        .config-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            border-radius: 12px; 
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba[0,0,0,0.1]; 
        }
        .option-btn { 
            transition: transform 0.1s ease, background-color 0.2s ease, border-color 0.2s ease; 
            padding: 12px;
            font-size: 1rem;
        }
        .option-btn:active { 
            transform: scale(0.95); 
        }
        .selected-btn { 
            background: #22c55e !important; 
            color:#fff !important; 
            border-color:#16a34a !important; 
            box-shadow: 0 4px 6px rgba[34,197,94,0.3];
        }
        .option-btn:not(.selected-btn):hover {
            background-color: #eff6ff; 
        }

        /* Preview Styling */
        .page-preview {
            border: 1px solid #333;
            width: 595px; 
            height: 842px; 
            margin: 20px auto;
            padding: 30px;
            background-color: white;
            box-shadow: 0 4px 10px rgba[0,0,0,0.1];
        }
        .equation-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            grid-template-rows: repeat(10, 1fr); 
            height: 100%; 
            font-size: 14pt; 
            gap: 0;
        }
        .equation {
            text-align: left;
            padding: 0 5px;
            line-height: 1.2;
            display: flex;
            align-items: center;
        }
        .page-number {
            text-align: center;
            padding-top: 15px;
            font-size: 10pt;
        }
    </style>
</head>
<body class="bg-blue-100 p-4">

    <div class="app-container">
        <h1 class="text-3xl md:text-4xl fredoka text-blue-800 text-center mb-6">Printable Math Worksheet</h1>

        <div id="range-section" class="config-section">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">1. Select Number Range (No Zeros in Operands):</h3>
            <div id="range-buttons" class="grid grid-cols-3 gap-3">
                <button type="button" data-range="1-10" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700 selected-btn">1 - 10</button>
                <button type="button" data-range="10-20" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700">10 - 20</button>
                <button type="button" data-range="1-20" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700">1 - 20</button>
            </div>
        </div>

        <div id="operation-section" class="config-section">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">2. Select Operations:</h3>
            <div id="operation-buttons" class="grid grid-cols-3 gap-3">
                <button type="button" data-op="+" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700 selected-btn">Addition (+)</button>
                <button type="button" data-op="-" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700">Subtraction (-)</button>
                <button type="button" data-op="+-" class="option-btn rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-700">Both (+ & -)</button>
            </div>
        </div>

        <div id="page-section" class="config-section">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">3. Number of Pages (60 Equations per page):</h3>
            <div class="flex items-center gap-4">
                <input type="number" id="page-count" value="1" min="1" class="w-20 text-center text-lg py-1 px-2 border-2 border-gray-300 rounded-lg focus:border-blue-500" />
                <button id="max-pages-btn" class="bg-orange-500 text-white py-2 px-4 rounded-full text-sm hover:bg-orange-600 active:scale-95 transition-transform shadow-md fredoka">Calculate Max</button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Max combinations: <span id="max-combinations" class="font-bold"></span></p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <button id="generate-btn" class="flex-1 bg-blue-500 text-white py-3 px-8 rounded-full text-xl fredoka hover:bg-blue-600 active:scale-95 transition-transform shadow-lg">Generate & Preview</button>
            <button id="download-pdf-btn" class="flex-1 bg-green-500 text-white py-3 px-8 rounded-full text-xl fredoka hover:bg-green-600 active:scale-95 transition-transform shadow-lg hidden">Download PDF</button>
        </div>

        <div id="preview-area" class="mt-8 border-t-2 border-gray-300 pt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">4. Preview (First Page)</h3>
            <div id="math-preview" class="page-preview overflow-y-auto">
                <p class="text-center text-gray-500 pt-4">Worksheet preview will appear here. Click "Calculate Max" or "Generate & Preview" to start.</p>
            </div>
        </div>
    </div>


    <script>
        const EQUATIONS_PER_PAGE = 60;
        const RESULT_MAX = 20; 
        const MIN_OPERAND = 1; // Constraint: Minimum value for num1 and num2 (No Zeros)

        // UI elements
        const generateBtn = document.getElementById('generate-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const mathPreview = document.getElementById('math-preview');
        const maxPagesBtn = document.getElementById('max-pages-btn');
        const rangeButtons = document.getElementById('range-buttons');
        const operationButtons = document.getElementById('operation-buttons');
        const maxCombinationsEl = document.getElementById('max-combinations');

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRangeLimits(rangeString) {
            const [min, max] = rangeString.split('-').map(Number);
            return { 
                minRange: min, 
                maxRange: max,
                // The actual minimum operand value must be at least 1 AND at least the range's lower bound (e.g., 10 for 10-20)
                effectiveMin: Math.max(MIN_OPERAND, min)
            };
        }

        // --- Core Logic for Problem Generation ---
        function generateProblem(opType, minVal, maxVal, effectiveMin) {
            let num1, num2, operator;
            let result;
            let attempts = 0;

            while (attempts < 100) { 
                if (opType === '+') {
                    operator = '+';
                    // num1 must be <= (RESULT_MAX - effectiveMin) to guarantee a valid num2 exists
                    const maxA = Math.min(maxVal, RESULT_MAX - effectiveMin);
                    num1 = getRandomInt(effectiveMin, maxA);
                    
                    // num2 must be <= (RESULT_MAX - num1)
                    const maxB = Math.min(maxVal, RESULT_MAX - num1);
                    num2 = getRandomInt(effectiveMin, maxB);
                    
                    result = num1 + num2;
                } else if (opType === '-') {
                    operator = '-';
                    // For subtraction, A and B must be in [effectiveMin, maxVal] and A >= B.
                    let a = getRandomInt(effectiveMin, maxVal);
                    let b = getRandomInt(effectiveMin, a); 
                    num1 = a; 
                    num2 = b; 
                    result = num1 - num2;
                } else {
                    return null;
                }
                
                // Final check (mainly for subtraction to ensure A and B are within the defined maxVal)
                if (num1 <= maxVal && num2 <= maxVal && num1 >= effectiveMin && num2 >= effectiveMin && result <= RESULT_MAX) {
                    return `${num1} ${operator} ${num2}`;
                }
                attempts++;
            }
            return "Error (Failed to generate)"; 
        }

        function generateEquations(rangeString, operationCode, numPages) {
            const { minRange, maxRange, effectiveMin } = getRangeLimits(rangeString);
            const totalEquations = numPages * EQUATIONS_PER_PAGE;
            const problems = [];
            const opTypes = [];
            
            if (operationCode.includes('+')) opTypes.push('+');
            if (operationCode.includes('-')) opTypes.push('-');
            
            if (opTypes.length === 0) return [];

            for (let i = 0; i < totalEquations; i++) {
                const op = opTypes[getRandomInt(0, opTypes.length - 1)];
                const problem = generateProblem(op, minRange, maxRange, effectiveMin);
                problems.push(problem);
            }
            return problems;
        }

        // --- PDF Generation (Layout Fixed) ---
        function createPDF(allEquations, numPages, rangeString) {
            const { minRange, maxRange, effectiveMin } = getRangeLimits(rangeString);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            
            const margin = 36; 
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const columnCount = 6;
            const rowCount = 10; 
            const ANSWER_LINE_LENGTH = 35; 
            const TEXT_BASELINE_OFFSET = 4; // Ensures the line is vertically centered with the text

            const contentWidth = pageWidth - 2 * margin;
            const equationWidth = contentWidth / columnCount; 
            
            const startY = margin + 30; 
            const contentHeight = pageHeight - startY - margin - 20;
            const equationHeight = contentHeight / rowCount; 

            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0); 

            for (let pageNum = 0; pageNum < numPages; pageNum++) {
                if (pageNum > 0) {
                    doc.addPage();
                }

                const pageEquations = allEquations.slice(
                    pageNum * EQUATIONS_PER_PAGE, 
                    (pageNum + 1) * EQUATIONS_PER_PAGE
                );

                // Page Title
                doc.setFontSize(18);
                doc.text(`Math Worksheet (Range: ${minRange}-${maxRange}, Max Result: ${RESULT_MAX})`, pageWidth / 2, margin + 10, { align: 'center' });
                doc.line(margin, margin + 15, pageWidth - margin, margin + 15);

                doc.setFontSize(12);
                
                pageEquations.forEach((eq, index) => {
                    const col = index % columnCount;
                    const row = Math.floor(index / columnCount);

                    const x = margin + (col * equationWidth); 
                    const y = startY + (row * equationHeight);
                    
                    const eqText = `${eq} =`;

                    // 1. Draw the Equation 
                    doc.text(eqText, x, y, { align: 'left' });
                    
                    // 2. Draw the Answer Line 
                    const lineY = y + TEXT_BASELINE_OFFSET; 
                    const lineStartX = x + doc.getTextWidth(eqText) + 5; 
                    const lineEndX = lineStartX + ANSWER_LINE_LENGTH; 
                    
                    doc.line(lineStartX, lineY, lineEndX, lineY); 
                });
                
                // Page Number
                doc.setFontSize(10);
                doc.text(`Page ${pageNum + 1} of ${numPages}`, pageWidth / 2, pageHeight - 15, { align: 'center' });
            }

            doc.save(`math_worksheet_${minRange}-${maxRange}_fixed.pdf`);
        }
        
        // --- Max Combinations Logic (FIXED and Verified) ---
        function calculateMaxCombinations(rangeString, operationCode) {
            let totalCombinations = 0;
            const { minRange, maxRange, effectiveMin } = getRangeLimits(rangeString);
            
            if (operationCode.includes('+')) {
                // Addition: A + B <= 20, A, B in [effectiveMin, maxRange]
                for (let a = effectiveMin; a <= maxRange; a++) {
                    for (let b = effectiveMin; b <= maxRange; b++) {
                        if (a + b <= RESULT_MAX) {
                            totalCombinations++;
                        }
                    }
                }
            }

            if (operationCode.includes('-')) {
                // Subtraction: A >= B, A, B in [effectiveMin, maxRange]
                for (let a = effectiveMin; a <= maxRange; a++) {
                    for (let b = effectiveMin; b <= maxRange; b++) {
                        if (a >= b) {
                            totalCombinations++; 
                        }
                    }
                }
            }

            return totalCombinations;
        }

        // --- UI & Event Handling ---
        function updateSelection(containerId, selectedElement) {
            document.getElementById(containerId).querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected-btn');
            });
            selectedElement.classList.add('selected-btn');
        }

        rangeButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                updateSelection('range-buttons', e.target);
                maxPagesBtn.click();
            }
        });

        operationButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                updateSelection('operation-buttons', e.target);
                maxPagesBtn.click();
            }
        });

        function getConfig() {
            const rangeBtn = document.querySelector('#range-buttons .selected-btn');
            const opBtn = document.querySelector('#operation-buttons .selected-btn');

            const rangeString = rangeBtn ? rangeBtn.dataset.range : '1-10';
            const operationCode = opBtn ? opBtn.dataset.op : '+';
            const numPages = parseInt(document.getElementById('page-count').value) || 1;

            return { rangeString, operationCode, numPages };
        }

        maxPagesBtn.addEventListener('click', () => {
            const { rangeString, operationCode } = getConfig();

            const totalCombinations = calculateMaxCombinations(rangeString, operationCode);
            const maxPages = Math.ceil(totalCombinations / EQUATIONS_PER_PAGE);
            
            maxCombinationsEl.textContent = 
                `${totalCombinations.toLocaleString()} equations / ${maxPages} pages`;
            document.getElementById('page-count').value = Math.max(1, maxPages);
        });
        
        generateBtn.addEventListener('click', () => {
            const { rangeString, operationCode, numPages } = getConfig();
            
            const allEquations = generateEquations(rangeString, operationCode, numPages);
            const { minRange, maxRange, effectiveMin } = getRangeLimits(rangeString);
            
            // 3. Update Preview
            mathPreview.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'text-center text-lg font-bold fredoka mb-4';
            header.textContent = `Worksheet: ${minRange}-${maxRange} (Max Result: ${RESULT_MAX}, Min Operand: ${effectiveMin})`;
            mathPreview.appendChild(header);

            const equationGrid = document.createElement('div');
            equationGrid.className = 'equation-grid';

            allEquations.slice(0, EQUATIONS_PER_PAGE).forEach(eq => {
                const div = document.createElement('div');
                div.className = 'equation';
                div.textContent = `${eq} = _________`; 
                equationGrid.appendChild(div);
            });

            mathPreview.appendChild(equationGrid);

            const footer = document.createElement('p');
            footer.className = 'page-number';
            footer.textContent = `Page 1 of ${numPages}`;
            mathPreview.appendChild(footer);

            downloadPdfBtn.classList.remove('hidden');

            // 4. Set up Download Button with generated data
            downloadPdfBtn.onclick = () => createPDF(allEquations, numPages, rangeString);
        });
        
        // Initial Calculation on Load
        document.addEventListener('DOMContentLoaded', () => {
            // Trigger calculation for the default selection (1-10, Addition)
            maxPagesBtn.click();
        });

    </script>
</body>
</html>
