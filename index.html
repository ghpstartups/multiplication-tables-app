<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multiplication Mastery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
        }
        .fredoka {
            font-family: 'Fredoka One', cursive;
        }
        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
            height: 100%;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        .answer-btn {
            transition: transform 0.1s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        .answer-btn:active {
            transform: scale(0.95);
        }
        .answer-btn.correct {
            background-color: #4ade80 !important;
            border-color: #22c55e !important;
            color: white;
        }
        .answer-btn.incorrect {
            background-color: #f87171 !important;
            border-color: #ef4444 !important;
            color: white;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); }
        }
        .modal-enter {
            animation: modal-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); }
        }
        .problem-tag {
            font-family: 'Fredoka One', cursive;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 0.9rem;
            min-height: 1.8rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            color: white;
            transition: background-color 0.3s ease, font-size 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
         .problem-tag span {
            font-size: 0.7rem;
            margin-left: 2px;
            opacity: 0.8;
        }
        /* Current question pulse */
        .is-current-question {
            animation: pulse-rainbow 2.5s infinite ease-in-out;
        }
        @keyframes pulse-rainbow {
            0%, 100% { 
                transform: scale(1.0); 
                box-shadow: 0 0 12px rgba(239, 68, 68, 0.7);
                background-color: #ef4444; /* red-500 */
            }
            25% { 
                transform: scale(1.1); 
                box-shadow: 0 0 15px rgba(251, 146, 60, 0.8);
                background-color: #f97316; /* orange-500 */
            }
            50% { 
                transform: scale(1.0); 
                box-shadow: 0 0 12px rgba(59, 130, 246, 0.7);
                background-color: #3b82f6; /* blue-500 */
            }
            75% { 
                transform: scale(1.1); 
                box-shadow: 0 0 15px rgba(34, 197, 94, 0.8);
                background-color: #22c55e; /* green-500 */
            }
        }
        /* Fireworks & Explosions */
        .particle {
            position: fixed;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
            z-index: 100;
        }
        @keyframes explode {
            from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: var(--transform-to); }
        }
        .tag-particle {
             position: fixed;
             border-radius: 50%;
             animation: tag-explode 0.6s ease-out forwards;
             z-index: 100;
        }
        @keyframes tag-explode {
            from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: var(--transform-to); }
        }

        /* Custom scrollbar for progress lists */
        .scrollable-list::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .scrollable-list::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        /* Orientation Lock */
        @media (orientation: landscape) and (max-height: 500px) {
            #setup-modal, #game-container, #win-modal, #practice-modal {
                display: none !important;
            }
            #orientation-lock {
                display: flex;
            }
        }

        /* Remove number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Responsive adjustments */
        #game-container {
            max-width: 100vw;
            width: 100%;
            padding: 0 5px;
        }
        .card-container {
            height: 30vh; /* Reduced height to avoid browser nav bar */
            max-height: 200px; /* Cap height for smaller screens */
            perspective: 1000px;
        }
        .card-face {
            padding: 2px; /* Reduced padding to use white space */
        }
        #problem {
            font-size: 4rem; /* Slightly smaller font for better fit */
        }
        #answer-options {
            gap: 2px; /* Tighter spacing for buttons */
        }
        .answer-btn {
            font-size: 1rem; /* Smaller font for buttons */
            padding: 4px;
        }

        /* Media queries for different devices */
        @media (max-width: 768px) {
            #game-container {
                padding: 0 2px;
            }
            .card-container {
                height: 25vh; /* Further reduce for smaller screens */
                max-height: 180px;
            }
            #problem {
                font-size: 3rem;
            }
            .answer-btn {
                font-size: 0.9rem;
            }
        }
        @media (orientation: landscape) {
            .card-container {
                height: 35vh; /* Slightly taller in landscape */
                max-height: 250px;
            }
        }
    </style>
</head>
<body class="bg-blue-100 flex flex-col items-center justify-center min-h-screen p-1">

    <!-- Orientation Lock Screen -->
    <div id="orientation-lock" class="hidden fixed inset-0 bg-blue-100 z-50 flex-col items-center justify-center text-center p-4">
        <svg class="w-16 h-16 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
        </svg>
        <h2 class="text-2xl fredoka text-blue-800 mt-4">Please rotate your device</h2>
        <p class="text-blue-600 mt-2">This game is best played in portrait mode.</p>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="modal-enter bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full z-20">
        <h2 class="text-3xl fredoka text-blue-800">Choose Your Tables!</h2>
        <p class="text-gray-600 mt-2">Practice any tables from 1 to 12.</p>
        <div class="flex items-center justify-center gap-4 my-4">
            <div>
                <label for="from-table" class="text-gray-700">From</label>
                <input type="number" id="from-table" class="w-20 text-center text-lg py-1 px-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="to-table" class="text-gray-700">To</label>
                <input type="number" id="to-table" class="w-20 text-center text-lg py-1 px-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
            </div>
        </div>
        <div class="flex items-center justify-center gap-3 my-4">
            <span class="text-gray-700">Sound</span>
            <button id="sound-toggle-btn" class="w-14 h-7 flex items-center bg-green-400 rounded-full p-1 duration-300 ease-in-out">
                <div id="sound-toggle-dot" class="w-5 h-5 bg-white rounded-full shadow-md transform translate-x-7 duration-300 ease-in-out"></div>
            </button>
        </div>
        <p id="setup-error" class="text-red-500 h-5 mb-2"></p>
        <button id="start-game-btn" class="w-full bg-blue-500 text-white py-3 px-8 rounded-full text-2xl fredoka hover:bg-blue-600 active:scale-95 transition-transform shadow-lg">Start</button>
    </div>

    <!-- Main Game -->
    <div id="game-container" class="w-full max-w-md mx-auto flex flex-col h-full hidden">
        <div class="text-center flex-shrink-0">
            <h1 class="text-2xl md:text-3xl fredoka text-blue-800">Multiplication Mastery</h1>
            <div class="flex items-center justify-center gap-4">
                <p id="clock" class="text-xl fredoka text-blue-700">00:00</p>
                <button id="restart-btn" class="bg-red-500 text-white py-1 px-3 rounded-full text-xs hover:bg-red-600 active:scale-95 transition-transform shadow-md">Restart</button>
            </div>
        </div>
        
        <div class="flex-grow flex flex-col gap-2 min-h-0 my-1">
            <!-- Progress Tracker -->
            <div class="bg-white/70 backdrop-blur-sm rounded-xl p-2 shadow-md flex flex-col" style="height: 40%;">
                <h2 class="text-xs text-center text-gray-700 mb-1 flex-shrink-0">PROGRESS (<span id="progress-count">0/0</span>)</h2>
                <div id="progress-container" class="scrollable-list overflow-y-auto flex-grow flex flex-wrap gap-1 justify-center content-start p-1"></div>
            </div>
            <!-- Wrong Tracker -->
             <div id="wrong-container" class="bg-white/70 backdrop-blur-sm rounded-xl p-2 shadow-md flex flex-col" style="height: 20%;">
                <h2 class="text-xs text-center text-orange-700 mb-1 flex-shrink-0">NEEDS PRACTICE (<span id="wrong-count">0</span>)</h2>
                <div id="wrong-list" class="scrollable-list overflow-y-auto flex-grow flex flex-wrap gap-1 justify-center content-start p-1"></div>
            </div>
            
            <!-- Card -->
            <div class="min-h-0 card-container">
                <div id="card" class="relative w-full card">
                    <div class="absolute w-full h-full card-face bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center p-2 text-center">
                        <p class="text-4xl fredoka text-gray-800" id="problem"></p>
                        <div id="answer-options" class="mt-2 grid grid-cols-2 gap-2 w-full"></div>
                    </div>
                    <div id="card-back-face" class="absolute w-full h-full card-face card-face-back bg-red-400 rounded-2xl shadow-xl flex flex-col items-center justify-center p-4 text-center transition-colors duration-300">
                        <div id="result-display" class="text-white"></div>
                        <p class="text-white/80 text-xs mt-3">Next question coming up...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Modal -->
    <div id="practice-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full relative">
            <div id="practice-fireworks-container" class="absolute inset-0 pointer-events-none overflow-hidden rounded-2xl"></div>
            <div class="text-8xl">üèÜ</div>
            <h2 class="text-4xl fredoka text-yellow-500 mt-4">Good Job!</h2>
            <p class="text-gray-700 mt-2 text-lg">But now let's practice the ones that you got wrong.</p>
            <div class="mt-6 flex flex-col gap-3">
                <button id="start-practice-btn" class="bg-yellow-500 text-white py-3 px-6 rounded-full text-lg fredoka hover:bg-yellow-600 active:scale-95 transition-transform shadow-lg">Practice Wrongs</button>
            </div>
        </div>
    </div>
    
    <!-- Win Modal -->
    <div id="win-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full relative">
            <div id="fireworks-container" class="absolute inset-0 pointer-events-none overflow-hidden rounded-2xl"></div>
            <div class="text-8xl">üèÜ</div>
            <h2 class="text-4xl fredoka text-yellow-500 mt-4">You Did It!</h2>
            <p id="win-message" class="text-gray-700 mt-2 text-lg"></p>
            <div class="mt-6 flex flex-col gap-3">
                <button id="play-again-btn" class="bg-blue-500 text-white py-3 px-8 rounded-full text-lg fredoka hover:bg-blue-600 active:scale-95 transition-transform shadow-lg">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Setup Elements
        const setupModalEl = document.getElementById('setup-modal');
        const fromTableInput = document.getElementById('from-table');
        const toTableInput = document.getElementById('to-table');
        const setupErrorEl = document.getElementById('setup-error');
        const startGameBtn = document.getElementById('start-game-btn');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const soundToggleDot = document.getElementById('sound-toggle-dot');
        const gameContainerEl = document.getElementById('game-container');

        // Game Elements
        const problemEl = document.getElementById('problem');
        const answerOptionsEl = document.getElementById('answer-options');
        const cardEl = document.getElementById('card');
        const cardBackFaceEl = document.getElementById('card-back-face');
        const resultDisplayEl = document.getElementById('result-display');
        
        const winModalEl = document.getElementById('win-modal');
        const playAgainBtn = document.getElementById('play-again-btn');
        const practiceModalEl = document.getElementById('practice-modal');
        const startPracticeBtn = document.getElementById('start-practice-btn');
        const restartBtn = document.getElementById('restart-btn');
        const winMessageEl = document.getElementById('win-message');
        const clockEl = document.getElementById('clock');
        const fireworksContainer = document.getElementById('fireworks-container');
        const practiceFireworksContainer = document.getElementById('practice-fireworks-container');
        
        const progressContainer = document.getElementById('progress-container');
        const progressCountEl = document.getElementById('progress-count');
        const wrongContainer = document.getElementById('wrong-container');
        const wrongListEl = document.getElementById('wrong-list');
        const wrongCountEl = document.getElementById('wrong-count');

        let isSoundOn = true, audioStarted = false;
        let currentProblem, correctAnswer, activeProblemKey = null;
        let allProblemsForRound = [], problemsToDo = [], problemsGottenWrongInRound = [];
        let allTimeWrongProblems = new Set();
        let wrongAttempts = {};
        let totalAttempts = 0;
        let timerInterval = null, startTime = 0;
        let initialProblemSet = [];

        // --- Sound Effects ---
        const correctSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
        const incorrectSynth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.5 }, volume: -10 }).toDestination();
        const fanfareSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fatsawtooth' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.4 } }).toDestination();

        function playCorrectSound() { if(isSoundOn) { correctSynth.triggerAttackRelease('C5', '8n', Tone.now()); correctSynth.triggerAttackRelease('G5', '8n', Tone.now() + 0.1); } }
        function playIncorrectSound() { if(isSoundOn) { incorrectSynth.triggerAttackRelease('F#3', '8n'); } }
        function playFanfare(isBig = false) {
            if(!isSoundOn) return;
            const now = Tone.now();
            fanfareSynth.triggerAttackRelease(['C5', 'G5', 'C6'], '8n', now);
            fanfareSynth.triggerAttackRelease(['E5', 'A5', 'E6'], '8n', now + 0.2);
            fanfareSynth.triggerAttackRelease(['G5', 'C6', 'G6'], '4n', now + 0.4);
            if (isBig) {
                fanfareSynth.triggerAttackRelease(['C5', 'G5', 'C6', 'E6'], '8n', now + 0.6);
                fanfareSynth.triggerAttackRelease(['D5', 'A5', 'D6', 'F6'], '8n', now + 0.8);
                fanfareSynth.triggerAttackRelease(['G5', 'B5', 'D6', 'G6'], '4n', now + 1.0);
            }
        }

        function handleStartSetup() {
            const from = parseInt(fromTableInput.value || 1);
            const to = parseInt(toTableInput.value || 12);
            let error = "";

            if (isNaN(from) || isNaN(to)) error = "Please enter numbers.";
            else if (from < 1 || to < 1 || from > 12 || to > 12) error = "Numbers must be between 1 and 12.";
            else if (from > to) error = "'From' must be smaller than 'To'.";
            
            setupErrorEl.textContent = error;
            if (error) return;

            let problems = [];
            for (let i = from; i <= to; i++) { for (let j = 1; j <= 10; j++) { problems.push([i, j]); } }
            
            initialProblemSet = [...problems];
            setupModalEl.classList.add('hidden');
            gameContainerEl.classList.remove('hidden');
            gameContainerEl.classList.add('flex');
            initializeRound(problems, true);
        }
        
        function initializeRound(problems, isFirstRound = false) {
            allProblemsForRound = problems.sort((a,b) => (a[0] * 100 + a[1]) - (b[0] * 100 + b[1]));
            problemsToDo = [...allProblemsForRound];
            problemsGottenWrongInRound = [];
            
            if (isFirstRound) {
                allTimeWrongProblems.clear();
                wrongAttempts = {};
                totalAttempts = 0;
                renderFullProgressList();
            } else {
                allTimeWrongProblems.clear();
                renderPracticeRoundProgressList();
            }
            
            winModalEl.classList.add('hidden');
            practiceModalEl.classList.add('hidden');
            
            if (isFirstRound) {
                if (timerInterval) clearInterval(timerInterval);
                startTime = Date.now();
                timerInterval = setInterval(updateClock, 1000);
            }
            updateClock();
            
            updateProgressCount();
            renderWrongList();
            generateProblem();
        }

        function updateClock() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
            const seconds = String(elapsedTime % 60).padStart(2, '0');
            clockEl.textContent = `${minutes}:${seconds}`;
        }

        function renderFullProgressList() {
            progressContainer.innerHTML = '';
            initialProblemSet.forEach(p => {
                const key = `${p[0]}x${p[1]}`;
                const tag = document.createElement('div');
                tag.id = `tag-${key}`;
                tag.className = 'problem-tag bg-red-400';
                tag.textContent = key;
                progressContainer.appendChild(tag);
            });
        }
        
        function renderPracticeRoundProgressList() {
            progressContainer.innerHTML = '';
            allProblemsForRound.forEach(p => {
                 const key = `${p[0]}x${p[1]}`;
                const tag = document.createElement('div');
                tag.id = `tag-${key}`;
                tag.className = 'problem-tag bg-red-400';
                tag.textContent = key;
                progressContainer.appendChild(tag);
            });
        }
        
        function renderWrongList() {
            const wrongProblemsArray = Array.from(allTimeWrongProblems).map(key => {
                 const parts = key.split('x');
                 return [parseInt(parts[0]), parseInt(parts[1])];
            });
            wrongCountEl.textContent = wrongProblemsArray.length;
            wrongListEl.innerHTML = '';
            
            wrongProblemsArray.sort((a,b) => (a[0] * 100 + a[1]) - (b[0] * 100 + b[1])).forEach(p => {
                const key = `${p[0]}x${p[1]}`;
                const tag = document.createElement('div');
                tag.id = `wrong-tag-${key}`;
                tag.className = 'problem-tag bg-orange-400';
                tag.innerHTML = `${key}`;
                wrongListEl.appendChild(tag);
            });
        }
        
        function updateProgressCount() {
            progressCountEl.textContent = `${initialProblemSet.length - allTimeWrongProblems.size}/${initialProblemSet.length}`;
        }
        
        function generateProblem() {
            if (activeProblemKey) { document.getElementById(`tag-${activeProblemKey}`)?.classList.remove('is-current-question'); }

            if (problemsToDo.length === 0) {
                if (problemsGottenWrongInRound.length > 0) {
                    practiceModalEl.classList.remove('hidden');
                    playFanfare();
                    triggerFireworks(practiceFireworksContainer);
                } else {
                    clearInterval(timerInterval);
                    const finalTime = clockEl.textContent;
                    winMessageEl.textContent = `You finished in ${finalTime} with ${totalAttempts} total attempts!`;
                    winModalEl.classList.remove('hidden');
                    playFanfare(true);
                    triggerFireworks(fireworksContainer);
                }
                return;
            }
            currentProblem = problemsToDo[Math.floor(Math.random() * problemsToDo.length)];
            const [num1, num2] = currentProblem;
            correctAnswer = num1 * num2;
            activeProblemKey = `${num1}x${num2}`;
            problemEl.textContent = activeProblemKey;
            
            const problemTag = document.getElementById(`tag-${activeProblemKey}`);
            if (problemTag) {
                problemTag.classList.add('is-current-question');
                problemTag.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            
            generateChoices();
        }

        function generateChoices() {
            let choices = new Set([correctAnswer]);
            const [num1, num2] = currentProblem;
            const deltas = [1, -1, 2, -2];
            for (let delta of deltas) {
                let wrongNum1 = num1 + delta;
                if (wrongNum1 >= 1 && wrongNum1 <= 12) {
                    let wrongAnswer = wrongNum1 * num2;
                    choices.add(wrongAnswer);
                }
                if (choices.size >= 4) break;
            }
            while (choices.size < 4) {
                let delta = Math.floor(Math.random() * 3) + 3;
                let sign = Math.random() > 0.5 ? 1 : -1;
                let wrongNum1 = num1 + sign * delta;
                if (wrongNum1 >= 1 && wrongNum1 <= 12) {
                    let wrongAnswer = wrongNum1 * num2;
                    if (!choices.has(wrongAnswer)) choices.add(wrongAnswer);
                }
            }
            displayChoices(Array.from(choices).sort(() => Math.random() - 0.5));
        }

        function displayChoices(choices) {
            answerOptionsEl.innerHTML = '';
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.classList.add('answer-btn', 'fredoka', 'text-xl', 'py-2', 'bg-blue-500', 'text-white', 'rounded-lg', 'shadow-md', 'hover:bg-blue-600');
                button.addEventListener('click', () => checkAnswer(choice, button));
                answerOptionsEl.appendChild(button);
            });
        }

        async function checkAnswer(userAnswer, button) {
            if (isSoundOn && !audioStarted) { await Tone.start(); audioStarted = true; }
            totalAttempts++;
            const isCorrect = userAnswer === correctAnswer;
            const problemKey = `${currentProblem[0]}x${currentProblem[1]}`;
            const problemTag = document.getElementById(`tag-${problemKey}`);

            problemTag.classList.remove('is-current-question');

            if (isCorrect) {
                playCorrectSound();
                problemsToDo = problemsToDo.filter(p => !(p[0] === currentProblem[0] && p[1] === currentProblem[1]));
                allTimeWrongProblems.delete(problemKey);
                
                problemTag.scrollIntoView({ behavior: "smooth", block: "center" });
                
                updateProgressCount();
                
                setTimeout(() => {
                    triggerTagExplosion(problemTag);
                    setTimeout(() => {
                        const positiveEmoticons = ['üòä', 'üéâ', 'üëç', 'üåü', 'ü§©', '‚úÖ', 'üíØ', 'üöÄ', 'üåà', 'ü¶Ñ', 'üçï', 'üé∏', 'ü§ñ', 'üëë', 'üéØ', 'üî•', 'üíé', '‚ú®', 'üéà', 'üéÅ', 'üê∂', 'üê±', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'ü¶Å', 'üêØ', 'ü¶ã', 'üêû', 'üçé', 'üçì', 'üèÜ', 'ü•á', 'üí°', 'üòé', 'üòá', 'üòâ', 'üòã', 'üòç', 'ü•≥', 'ü§Ø', 'ü§†', 'üôå', 'üëè', 'üí™', 'üß†', 'üèÖ', 'üéä', 'üí´', 'üí•', '‚úîÔ∏è', 'üõ∏', '‚ö°', '‚òÄÔ∏è', '‚≠ê', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üê≠', 'üêπ', 'üê∞', 'üêÆ', 'üê∑', 'üê∏', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'üê¥', 'üêù', 'üê¢', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêô', 'üêö', 'ü¶Ä', 'üçí', 'üçë', 'üçç', 'ü•ù', 'üçÖ', 'ü•ë', 'ü•¶', 'ü•ï', 'ü•ê', 'üçû', 'üßÄ', 'ü•ö', 'üç≥', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'üå≠', 'üçî', 'üçü', 'ü•™', 'üåÆ', 'üç£', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéÆ', 'üß©', 'üòÑ'];
                        const randomEmoticon = positiveEmoticons[Math.floor(Math.random() * positiveEmoticons.length)];
                        problemTag.innerHTML = randomEmoticon;
                        problemTag.style.fontSize = '1.2rem';
                        problemTag.classList.remove('bg-red-400', 'bg-orange-400');
                        problemTag.classList.add('bg-green-400');
                    }, 300);
                }, 200);

                setTimeout(nextQuestion, 1000);

            } else {
                const buttons = answerOptionsEl.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                playIncorrectSound();
                button.classList.add('incorrect');
                buttons.forEach(btn => { if (parseInt(btn.textContent) === correctAnswer) btn.classList.add('correct'); });
                
                problemTag.parentNode.removeChild(problemTag);
                wrongAttempts[problemKey] = (wrongAttempts[problemKey] || 0) + 1;
                allTimeWrongProblems.add(problemKey);
                problemsGottenWrongInRound.push(currentProblem);
                problemsToDo = problemsToDo.filter(p => !(p[0] === currentProblem[0] && p[1] === currentProblem[1]));
                
                renderWrongList();
                const wrongTag = document.getElementById(`wrong-tag-${problemKey}`);
                if (wrongTag) { wrongTag.scrollIntoView({ behavior: "smooth", block: "center" }); }
                
                resultDisplayEl.innerHTML = `<p class="fredoka text-5xl">${problemKey}=${correctAnswer}</p>`;
                
                setTimeout(() => cardEl.classList.add('is-flipped'), 500);
                setTimeout(nextQuestion, 2500);
            }
            updateProgressCount();
        }
        
        function nextQuestion() { 
            if (cardEl.classList.contains('is-flipped')) {
                cardEl.classList.remove('is-flipped');
                setTimeout(generateProblem, 300);
            } else {
                generateProblem();
            }
        }
        
        function triggerTagExplosion(tagElement) {
            const rect = tagElement.getBoundingClientRect();
            const colors = ['#FFD700', '#FFC300', '#FFFFFF', '#FFBF00', '#f97316'];
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'tag-particle';
                const s = Math.floor(Math.random() * 6 + 3) + 'px';
                p.style.width = s; p.style.height = s;
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = `${rect.left + rect.width / 2}px`;
                p.style.top = `${rect.top + rect.height / 2}px`;
                const transformTo = `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) scale(0)`;
                p.style.setProperty('--transform-to', transformTo);
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        }

        function triggerFireworks(containerEl) {
            containerEl.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const s = Math.floor(Math.random() * 10 + 5) + 'px';
                p.style.width = s; p.style.height = s;
                p.style.backgroundColor = ['#ffc700', '#ff0000', ' #22c55e', '#3b82f6', '#8b5cf6'][Math.floor(Math.random() * 5)];
                p.style.left = '50%'; p.style.top = '50%';
                p.style.setProperty('--transform-to', `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) scale(0)`);
                containerEl.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }
        
        function showSetupScreen() {
            if (timerInterval) clearInterval(timerInterval);
            winModalEl.classList.add('hidden');
            gameContainerEl.classList.add('hidden');
            gameContainerEl.classList.remove('flex');
            fromTableInput.value = '';
            toTableInput.value = '';
            setupModalEl.classList.remove('hidden');
        }

        soundToggleBtn.addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            if (isSoundOn) {
                soundToggleBtn.classList.remove('bg-gray-300');
                soundToggleBtn.classList.add('bg-green-400');
                soundToggleDot.style.transform = 'translateX(1.75rem)';
            } else {
                soundToggleBtn.classList.add('bg-gray-300');
                soundToggleBtn.classList.remove('bg-green-400');
                soundToggleDot.style.transform = 'translateX(0)';
            }
        });

        startGameBtn.addEventListener('click', handleStartSetup);
        playAgainBtn.addEventListener('click', showSetupScreen);
        startPracticeBtn.addEventListener('click', () => {
            if(problemsGottenWrongInRound.length > 0) {
                 initializeRound(problemsGottenWrongInRound, false);
            }
        });
        restartBtn.addEventListener('click', showSetupScreen);
        
    </script>
</body>
</html>
